<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tic-Tac-Toe â€“ Multiplayer</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body { @apply bg-gradient-to-br from-indigo-700 to-purple-700 flex items-center justify-center min-h-screen text-white; }
    .square { @apply w-20 h-20 sm:w-24 sm:h-24 flex items-center justify-center text-4xl font-bold cursor-pointer select-none bg-white/20 backdrop-blur rounded-lg transition; }
    .square.disabled { @apply cursor-not-allowed bg-white/5; }
    .board { @apply grid grid-cols-3 gap-3; }
  </style>
</head>

<body>
  <div class="text-center space-y-6">
    <h1 class="text-3xl font-extrabold">Tic-Tac-Toe ðŸ”¥</h1>
    <p id="status" class="italic text-sm"></p>

    <div id="board" class="board mx-auto"></div>

    <button id="restartBtn" class="hidden bg-emerald-500 hover:bg-emerald-600 px-4 py-2 rounded">
      ðŸ”„ Play Again
    </button>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

    /* ----------  CONFIG ---------- */
    const SUPABASE_URL = 'https://vmronlbzksuiikspvlvz.supabase.co'
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZtcm9ubGJ6a3N1aWlrc3B2bHZ6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk5ODMwNTcsImV4cCI6MjA2NTU1OTA1N30.WMKbpJn1aavkwQDmsYq_-4EMSLL9tc4LexpmRSCsmSM'
    const XP_PER_WIN   = 50
    /* -------------------------------- */

    const supabase   = createClient(SUPABASE_URL, SUPABASE_KEY)
    const statusEl   = document.getElementById('status')
    const boardEl    = document.getElementById('board')
    const restartBtn = document.getElementById('restartBtn')

    /* ----------  Globals ---------- */
    let sessionId          = new URLSearchParams(location.search).get('session') || null
    let currentUser        = null
    let gameSession        = null
    let isPlayer1          = null
    let mySymbol           = null
    let theirSymbol        = null
    let boardState         = Array(9).fill(null)
    let gameOver           = false
    let currentXP          = 0   // live XP display

    /* =====  MAIN ===== */
    init()

    async function init () {
      /* 1. Auth */
      const { data: { user } } = await supabase.auth.getUser()
      if (!user) { alert('Please log in first.'); location.href = '/login.html'; return }
      currentUser = user

      /* 2. Create session on the fly if missing */
      if (!sessionId) {
        const { data: game } = await supabase.from('games').select('id').eq('slug','tic-tac-toe').single()
        const { data: newSession } = await supabase.from('game_sessions')
          .insert({ game_id: game.id, player1_id: user.id, status:'waiting' })
          .select().single()
        sessionId = newSession.id
        history.replaceState({}, '', `${location.pathname}?session=${sessionId}`)
        alert('Invite link copied to clipboard! Send it to a friend.')
        await navigator.clipboard.writeText(location.href)
      }

      /* 3. Join / claim session */
      await joinSession()

      /* 4. Fetch XP & render */
      await fetchXP()
      renderBoard()

      /* 5. Realtime */
      subscribeMoves()
      subscribeSession()
    }

    /* ----------  Session logic ---------- */
    async function joinSession () {
      const { data, error } = await supabase.from('game_sessions').select('*').eq('id',sessionId).single()
      if (error) { alert('Session not found'); return }
      gameSession = data

      if (gameSession.player1_id === currentUser.id) {
        isPlayer1 = true
      } else if (!gameSession.player2_id) {
        const { data: upd } = await supabase.from('game_sessions')
          .update({ player2_id: currentUser.id, status:'in_progress' })
          .eq('id',sessionId).select().single()
        gameSession = upd
        isPlayer1   = false
      } else if (gameSession.player2_id === currentUser.id) {
        isPlayer1 = false
      } else {
        alert('Session already full.'); location.href='/playgames.html'; return
      }

      mySymbol    = isPlayer1 ? 'X':'O'
      theirSymbol = isPlayer1 ? 'O':'X'
      statusEl.textContent = (gameSession.status === 'waiting')
        ? 'Waiting for friend to joinâ€¦'
        : (isMyTurn() ? 'Your turn!' : 'Opponentâ€™s turnâ€¦')
      updateXPText()
    }

    /* ----------  XP helpers ---------- */
    async function fetchXP () {
      const { data, error } = await supabase.from('profiles').select('xp').eq('id',currentUser.id).single()
      if (!error) currentXP = data.xp
    }
    function updateXPText () {
      let xpEl = document.getElementById('xpDisplay')
      if (!xpEl) {
        xpEl = document.createElement('div')
        xpEl.id = 'xpDisplay'
        xpEl.className = 'text-xs mt-1'
        statusEl.appendChild(xpEl)
      }
      xpEl.textContent = `Your XP: ${currentXP}`
    }

    /* ----------  Board ---------- */
    function renderBoard () {
      boardEl.innerHTML = ''
      boardState.forEach((val,i)=>{
        const d=document.createElement('div')
        d.className='square'+(val?' disabled':'')
        d.textContent = val??''
        if(!val && !gameOver) d.onclick=()=>makeMove(i)
        boardEl.appendChild(d)
      })
    }

    /* ----------  Moves ---------- */
    async function makeMove(idx){
      if(gameOver) return
      if(!isMyTurn()) { alert('Wait for your turn'); return }
      if(boardState[idx]){ alert('Square taken'); return }

      await supabase.from('game_moves').insert({
        session_id:sessionId,
        player_id: currentUser.id,
        square:idx,
        symbol:mySymbol
      })
    }
    function applyMove(mv){
      if(boardState[mv.square]) return
      boardState[mv.square]=mv.symbol
      renderBoard()

      if(checkWin(mv.symbol)){
        declareWinner(mv.player_id)
      }else if(boardState.every(Boolean)){
        declareDraw()
      }else if(!gameOver){
        statusEl.firstChild.textContent = isMyTurn() ? 'Your turn!' : 'Opponentâ€™s turnâ€¦'
      }
    }

    /* ----------  Realtime listeners ---------- */
    function subscribeMoves(){
      supabase.from('game_moves')
        .select('*')
        .eq('session_id',sessionId)
        .order('created_at',{ascending:true})
        .then(({ data }) => data.forEach(applyMove))

      supabase.channel('moves:'+sessionId)
        .on('postgres_changes',
          { event:'INSERT', schema:'public', table:'game_moves', filter:`session_id=eq.${sessionId}`},
          payload=>applyMove(payload.new))
        .subscribe()
    }
    function subscribeSession(){
      supabase.channel('session:'+sessionId)
        .on('postgres_changes',
          { event:'UPDATE', schema:'public', table:'game_sessions', filter:`id=eq.${sessionId}`},
          ({ new:upd })=>{
            gameSession=upd
            if(gameSession.status==='completed' && !gameOver){
              finishGame(gameSession.winner_id===currentUser.id)
            }
            if(gameSession.status==='in_progress' && !gameOver){
              statusEl.firstChild.textContent = isMyTurn() ? 'Your turn!' : 'Opponentâ€™s turnâ€¦'
            }
          })
        .subscribe()
    }

    /* ----------  Helpers ---------- */
    function isMyTurn(){
      const total=boardState.filter(Boolean).length
      return (total%2===0)===isPlayer1
    }
    function checkWin(sym){
      const lines=[[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]]
      return lines.some(l=>l.every(i=>boardState[i]===sym))
    }

    async function declareWinner(winnerId){
      gameOver=true
      const iWon = winnerId===currentUser.id
      statusEl.firstChild.textContent = iWon ? 'ðŸŽ‰ You win!' : 'ðŸ˜© You lose!'
      restartBtn.classList.remove('hidden')

      if(gameSession.winner_id) { updateXPText(); return } // already processed

      if(iWon){
        // mark session & give XP
        await supabase.from('game_sessions')
          .update({ winner_id:winnerId, status:'completed' })
          .eq('id',sessionId)

        await supabase.rpc('increment_xp',{ uid:winnerId, pts:XP_PER_WIN })

        // fetch new XP, show popup
        await fetchXP(); updateXPText()
        alert(`ðŸ† You win!\n+${XP_PER_WIN} XP\nTotal XP: ${currentXP}`)
      }
    }
    function declareDraw(){
      gameOver=true
      statusEl.firstChild.textContent='ðŸ¤ Draw!'
      restartBtn.classList.remove('hidden')
      supabase.from('game_sessions').update({ status:'completed'}).eq('id',sessionId)
    }

    /* ----------  Restart ---------- */
    restartBtn.onclick = ()=>location.href='/play/tic-tac-toe.html'
  </script>
</body>
</html>
