<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> TakaTV </title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- HLS.js for Video Playback -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        neutral: {
                            850: '#1f1f1f',
                            900: '#171717',
                            950: '#0a0a0a',
                        },
                        emerald: {
                            450: '#10b981', // Custom accent
                        }
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>

    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #171717; 
        }
        ::-webkit-scrollbar-thumb {
            background: #333; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #10b981; 
        }
        
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Player Animation */
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .modal-animate {
            animation: fadeIn 0.2s ease-out forwards;
        }
        
        /* Accordion transition */
        .accordion-content {
            transition: max-height 0.3s ease-in-out, opacity 0.3s ease-in-out;
            max-height: 0;
            opacity: 0;
            overflow: hidden;
        }
        .accordion-content.open {
            max-height: 500px; /* Arbitrary large number */
            opacity: 1;
        }
        /* Specific max-height for scrollable language list */
        .accordion-content.scrollable.open {
            max-height: 300px; 
            overflow-y: auto;
        }

        /* Live Indicator Pulse */
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 6px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        .live-glow {
            animation: pulse-red 2s infinite;
        }
        
        /* Error Box Shake Animation */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-4px); }
            20%, 40%, 60%, 80% { transform: translateX(4px); }
        }
        .animate-shake {
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
        }
    </style>
</head>
<body class="bg-neutral-950 text-neutral-100 font-sans h-screen overflow-hidden flex flex-col selection:bg-emerald-500/30 selection:text-emerald-200">

    <!-- VIDEO PLAYER MODAL (Hidden by default) -->
    <div id="videoModal" class="fixed inset-0 z-50 bg-black/95 hidden flex flex-col items-center justify-center p-4">
        <!-- Player Container (Target for Fullscreen) -->
        <div id="playerContainer" class="w-full max-w-5xl aspect-video bg-black relative shadow-2xl shadow-emerald-900/20 rounded-xl overflow-hidden modal-animate border border-white/10 group">
            <video id="videoPlayer" class="w-full h-full object-contain" playsinline controls poster="https://via.placeholder.com/1280x720/000000/10b981?text=Loading+Stream..."></video>
            
            <!-- --- Top Controls Overlay --- -->
            
            <!-- Close Button -->
            <button onclick="closePlayer()" class="absolute top-4 right-4 bg-red-600/90 hover:bg-red-600 text-white rounded-full p-2 transition-transform hover:scale-110 z-20 shadow-lg backdrop-blur-sm" title="Close">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>

            <!-- Fullscreen Button -->
            <button onclick="toggleFullscreen()" class="absolute top-4 right-16 bg-neutral-800/80 hover:bg-neutral-700 text-white rounded-full p-2 transition-transform hover:scale-110 z-20 shadow-lg backdrop-blur-sm" title="Fullscreen">
                <i data-lucide="maximize" class="w-5 h-5"></i>
            </button>

            <!-- Info Button -->
            <button onclick="toggleInfo()" class="absolute top-4 right-28 bg-neutral-800/80 hover:bg-neutral-700 text-white rounded-full p-2 transition-transform hover:scale-110 z-20 shadow-lg backdrop-blur-sm" title="Channel Info">
                <i data-lucide="info" class="w-5 h-5"></i>
            </button>

            <!-- --- Top Left Info --- -->
            <div class="absolute top-4 left-4 z-10 flex flex-col gap-2 pointer-events-none">
                <!-- Live Badge -->
                <button id="liveButton" onclick="syncLive()" class="bg-neutral-900/80 backdrop-blur-md px-3 py-1.5 rounded-lg border border-white/10 flex items-center gap-2 transition-all pointer-events-auto hover:bg-neutral-800 group/live">
                    <div id="liveDot" class="w-2.5 h-2.5 rounded-full bg-neutral-500"></div>
                    <span class="text-xs font-bold tracking-wider group-hover/live:text-emerald-400 transition-colors">LIVE</span>
                </button>

                <!-- Channel Info Card (Hidden/Shown via JS) -->
                <div id="playerInfoCard" class="bg-black/80 backdrop-blur-md p-4 rounded-lg border border-white/10 max-w-xs transition-opacity opacity-0 hidden">
                     <h2 id="playerChannelName" class="font-bold text-lg text-white mb-2 leading-tight">Channel Name</h2>
                     <div class="space-y-1 text-xs text-neutral-300">
                         <div class="flex items-center gap-2"><i data-lucide="globe" class="w-3 h-3 text-neutral-500"></i> <span id="infoCountry">Country</span></div>
                         <div class="flex items-center gap-2"><i data-lucide="languages" class="w-3 h-3 text-neutral-500"></i> <span id="infoLang">Language</span></div>
                         <div class="flex items-center gap-2"><i data-lucide="film" class="w-3 h-3 text-neutral-500"></i> <span id="infoCategory">Category</span></div>
                     </div>
                </div>
            </div>
            
             <!-- IMPROVED ERROR OVERLAY (Hidden by default) -->
            <div id="playerError" class="absolute inset-0 bg-black/95 backdrop-blur-sm flex flex-col items-center justify-center text-center p-4 sm:p-8 hidden z-30 animate-shake">
                <div class="max-w-md w-full bg-neutral-900/90 border border-white/10 rounded-2xl p-6 shadow-2xl relative overflow-hidden">
                    
                    <!-- Decorative background glow -->
                    <div class="absolute -top-10 -right-10 w-32 h-32 bg-yellow-500/10 rounded-full blur-3xl pointer-events-none"></div>
                    <div class="absolute -bottom-10 -left-10 w-32 h-32 bg-red-500/10 rounded-full blur-3xl pointer-events-none"></div>

                    <!-- Icon -->
                    <div class="w-16 h-16 bg-yellow-500/10 rounded-full flex items-center justify-center mx-auto mb-4 border border-yellow-500/20">
                        <i data-lucide="lock" class="w-8 h-8 text-yellow-500"></i>
                    </div>

                    <h3 class="text-xl font-bold text-white mb-2">Premium Access Required</h3>
                    <p id="errorDescription" class="text-neutral-400 text-sm mb-6 leading-relaxed">
                        This channel requires paid access so we have blocked this stream.
                    </p>

                    <!-- Debug Info (Collapsible) -->
                    <div class="bg-black/50 rounded-lg p-3 mb-6 text-left border border-white/5 relative group/code">
                        <div class="flex items-center justify-between mb-1">
                            <span class="text-[10px] font-bold text-neutral-500 uppercase tracking-wider">Technical Details</span>
                            <button onclick="copyErrorDetails()" class="text-[10px] text-emerald-500 hover:text-emerald-400 opacity-0 group-hover/code:opacity-100 transition-opacity">Copy</button>
                        </div>
                        <code id="errorTechnical" class="block font-mono text-xs text-red-400 truncate">Access Denied</code>
                    </div>

                    <!-- Actions -->
                    <div class="w-full">
                        <button onclick="closePlayer()" class="w-full px-4 py-3 bg-white text-black hover:bg-neutral-200 rounded-xl text-sm font-bold transition-colors flex items-center justify-center gap-2">
                            <i data-lucide="arrow-left" class="w-4 h-4"></i>
                            Go Back to Channels
                        </button>
                    </div>
                </div>
            </div>

            <!-- Loading Spinner Overlay (Visible during buffering/loading) -->
            <div id="playerLoader" class="absolute inset-0 z-20 flex items-center justify-center pointer-events-none hidden">
                <div class="w-12 h-12 border-4 border-emerald-500/30 border-t-emerald-500 rounded-full animate-spin"></div>
            </div>
        </div>
    </div>

    <!-- APP HEADER -->
    <header class="h-16 bg-neutral-900/80 backdrop-blur-md border-b border-white/5 flex items-center px-4 z-40 shrink-0">
        <!-- Mobile Menu Toggle -->
        <button onclick="toggleSidebar()" class="lg:hidden p-2 mr-2 text-neutral-400 hover:text-white hover:bg-white/5 rounded-lg">
            <i data-lucide="menu" class="w-6 h-6"></i>
        </button>

        <!-- Logo -->
        <div class="flex items-center gap-2 mr-8 cursor-pointer group" onclick="setFilter('all')">
            <div class="w-8 h-8 bg-gradient-to-tr from-emerald-600 to-teal-500 rounded-lg flex items-center justify-center shadow-lg shadow-emerald-900/20 group-hover:scale-105 transition-transform">
                <i data-lucide="play" class="w-4 h-4 text-white fill-current ml-0.5"></i>
            </div>
            <span class="text-xl font-bold tracking-tight bg-gradient-to-r from-white to-neutral-400 bg-clip-text text-transparent">TakaTV</span>
        </div>

        <!-- Desktop Search -->
        <div class="flex-1 max-w-xl relative hidden md:block group">
            <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-neutral-500 group-focus-within:text-emerald-500 transition-colors"></i>
            <input 
                type="text" 
                id="searchInputDesktop"
                placeholder="Search channels..." 
                class="w-full bg-neutral-800/50 border border-white/5 rounded-full py-2.5 pl-10 pr-4 text-sm focus:outline-none focus:border-emerald-500/50 focus:bg-neutral-800 focus:ring-4 focus:ring-emerald-500/10 transition-all placeholder:text-neutral-600 text-white"
            >
        </div>

        <!-- Right Actions -->
        <div class="ml-auto flex items-center gap-3">
             <div class="hidden sm:flex items-center text-xs font-mono text-emerald-500 bg-emerald-500/10 px-3 py-1 rounded-full border border-emerald-500/20 animate-pulse-slow">
               LIVE
             </div>
             <button onclick="setFilter('favorites')" id="headerFavBtn" class="p-2 rounded-full transition-all duration-300 text-neutral-400 hover:text-red-400 hover:bg-neutral-800">
                <i data-lucide="heart" class="w-5 h-5"></i>
             </button>
        </div>
    </header>

    <!-- MAIN LAYOUT -->
    <div class="flex flex-1 overflow-hidden relative">
        
        <!-- SIDEBAR -->
        <aside id="sidebar" class="absolute inset-y-0 left-0 w-72 bg-neutral-900 border-r border-white/5 z-30 transform -translate-x-full lg:relative lg:translate-x-0 transition-transform duration-300 ease-in-out flex flex-col">
            <div class="h-full overflow-y-auto p-4 custom-scrollbar">
                
                <!-- Mobile Header in Sidebar -->
                <div class="flex items-center justify-between lg:hidden mb-6">
                    <span class="font-bold text-lg text-neutral-200">Menu</span>
                    <button onclick="toggleSidebar()" class="p-2 hover:bg-white/10 rounded-lg"><i data-lucide="x" class="w-5 h-5"></i></button>
                </div>

                <!-- Main Nav -->
                <nav class="space-y-1 mb-6">
                    <button onclick="setFilter('all')" id="nav-all" class="w-full flex items-center gap-3 px-3 py-2.5 rounded-xl text-sm font-medium transition-all text-neutral-400 hover:bg-white/5 hover:text-white">
                        <i data-lucide="monitor" class="w-4 h-4"></i>
                        <span>All Channels</span>
                    </button>
                    <button onclick="setFilter('favorites')" id="nav-favorites" class="w-full flex items-center gap-3 px-3 py-2.5 rounded-xl text-sm font-medium transition-all text-neutral-400 hover:bg-white/5 hover:text-white">
                        <i data-lucide="heart" class="w-4 h-4"></i>
                        <span>Favorites</span>
                    </button>
                </nav>

                <hr class="border-white/5 mb-6">

                <!-- Featured Countries (Quick Access) -->
                <div class="mb-4">
                    <h3 class="text-xs font-bold text-neutral-500 uppercase tracking-widest mb-2 px-3 flex items-center gap-2">
                        Featured
                    </h3>
                    <div class="space-y-1">
                        <button onclick="setFilter('country', 'IN')" id="nav-country-IN" class="w-full flex items-center gap-3 px-3 py-2 rounded-lg text-sm font-medium transition-all text-neutral-400 hover:bg-white/5 hover:text-white">
                            <span class="text-lg w-5 text-center">ðŸ‡®ðŸ‡³</span>
                            <span>India</span>
                        </button>
                        <button onclick="setFilter('country', 'US')" id="nav-country-US" class="w-full flex items-center gap-3 px-3 py-2 rounded-lg text-sm font-medium transition-all text-neutral-400 hover:bg-white/5 hover:text-white">
                            <span class="text-lg w-5 text-center">ðŸ‡ºðŸ‡¸</span>
                            <span>USA</span>
                        </button>
                        <button onclick="setFilter('country', 'UK')" id="nav-country-UK" class="w-full flex items-center gap-3 px-3 py-2 rounded-lg text-sm font-medium transition-all text-neutral-400 hover:bg-white/5 hover:text-white">
                            <span class="text-lg w-5 text-center">ðŸ‡¬ðŸ‡§</span>
                            <span>UK</span>
                        </button>
                    </div>
                </div>

                <!-- ACCORDIONS -->

                <!-- Genres Accordion -->
                <div class="mb-2">
                    <button onclick="toggleAccordion('genresList')" class="w-full flex items-center justify-between px-3 py-2 text-xs font-bold text-neutral-500 uppercase tracking-widest hover:text-neutral-300 transition-colors">
                        <div class="flex items-center gap-2"><i data-lucide="film" class="w-3 h-3"></i> Genres</div>
                        <i data-lucide="chevron-down" id="icon-genresList" class="w-3 h-3 transition-transform"></i>
                    </button>
                    <div id="genresList" class="accordion-content space-y-1 px-1">
                        <!-- Genres injected here -->
                    </div>
                </div>

                <!-- Languages Accordion (Scrollable) -->
                <div class="mb-2">
                    <button onclick="toggleAccordion('languagesList')" class="w-full flex items-center justify-between px-3 py-2 text-xs font-bold text-neutral-500 uppercase tracking-widest hover:text-neutral-300 transition-colors">
                        <div class="flex items-center gap-2"><i data-lucide="languages" class="w-3 h-3"></i> Languages</div>
                        <i data-lucide="chevron-down" id="icon-languagesList" class="w-3 h-3 transition-transform"></i>
                    </button>
                    <div id="languagesList" class="accordion-content scrollable space-y-1 px-1 custom-scrollbar">
                        <!-- Languages injected here -->
                    </div>
                </div>

                 <!-- Countries Accordion (Scrollable) -->
                 <div class="mb-8">
                    <button onclick="toggleAccordion('countriesList')" class="w-full flex items-center justify-between px-3 py-2 text-xs font-bold text-neutral-500 uppercase tracking-widest hover:text-neutral-300 transition-colors">
                        <div class="flex items-center gap-2"><i data-lucide="globe" class="w-3 h-3"></i> All Countries</div>
                        <i data-lucide="chevron-down" id="icon-countriesList" class="w-3 h-3 transition-transform"></i>
                    </button>
                    <div id="countriesList" class="accordion-content scrollable space-y-1 px-1 custom-scrollbar">
                        <!-- Countries injected here -->
                    </div>
                </div>

            </div>
        </aside>

        <!-- MAIN CONTENT AREA -->
        <main id="mainContent" class="flex-1 overflow-y-auto p-4 lg:p-8 relative scroll-smooth bg-neutral-950">
            
            <!-- Mobile Search -->
            <div class="md:hidden mb-6">
                <div class="relative group">
                    <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-neutral-500"></i>
                    <input 
                        type="text" 
                        id="searchInputMobile"
                        placeholder="Search channels..." 
                        class="w-full bg-neutral-900 border border-neutral-800 rounded-full py-2.5 pl-10 pr-4 text-sm focus:outline-none focus:border-emerald-500 focus:ring-1 focus:ring-emerald-500 text-white"
                    >
                </div>
            </div>

            <!-- Page Title Area -->
            <div class="mb-6 flex flex-col md:flex-row md:items-center justify-between gap-4">
                <div>
                    <h2 id="pageTitle" class="text-2xl md:text-3xl font-bold flex items-center gap-3 text-white">
                        <span id="pageTitleText">Loading...</span>
                    </h2>
                    <p id="channelCount" class="text-neutral-500 text-sm mt-1">Starting up...</p>
                </div>
            </div>

            <!-- Loading State -->
            <div id="loadingState" class="flex flex-col items-center justify-center py-32">
                <div class="relative w-16 h-16 mb-4">
                    <div class="absolute inset-0 border-4 border-neutral-800 rounded-full"></div>
                    <div class="absolute inset-0 border-4 border-emerald-500 border-t-transparent rounded-full animate-spin"></div>
                </div>
                <p id="loadingText" class="text-neutral-500 font-mono text-sm animate-pulse">Initializing TakaTV...</p>
            </div>

            <!-- Empty State -->
            <div id="emptyState" class="hidden flex flex-col items-center justify-center py-32 text-neutral-500 border-2 border-dashed border-neutral-800 rounded-3xl">
                <i data-lucide="signal" class="w-16 h-16 mb-6 opacity-20"></i>
                <p class="text-xl font-medium text-neutral-400">No channels found</p>
                <p class="text-sm mt-2">Try adjusting your search or filters.</p>
            </div>

            <!-- Grid -->
            <div id="channelGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4 sm:gap-6 pb-20">
                <!-- Channels injected here -->
            </div>
            
            <!-- Load More -->
            <div id="loadMoreContainer" class="hidden mt-12 text-center pb-20">
                 <button onclick="loadMoreChannels()" class="px-8 py-3 bg-neutral-800 hover:bg-neutral-700 text-white rounded-full font-medium transition-all hover:pr-12 group relative">
                    Load More
                    <i data-lucide="chevron-right" class="absolute right-4 top-1/2 -translate-y-1/2 w-4 h-4 opacity-0 group-hover:opacity-100 transition-all -translate-x-2 group-hover:translate-x-0"></i>
                 </button>
            </div>

            <!-- Footer -->
            <footer class="mt-auto py-8 text-center border-t border-white/5">
                <p class="text-neutral-500 text-sm">Powered by TakaDori</p>
            </footer>
        </main>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        // --- Global State ---
        const state = {
            channels: [], 
            categories: [], // Now mapped to "Genre"
            countries: [],
            languages: [],
            favorites: JSON.parse(localStorage.getItem('takaTV_favorites') || '[]'),
            
            // Filter State
            activeTab: 'country', // 'all', 'favorites', 'country', 'category', 'language'
            filterValue: 'IN',    // Default to India
            searchQuery: '',
            
            // Pagination
            displayLimit: 60,
            
            // DOM References
            grid: document.getElementById('channelGrid'),
            titleText: document.getElementById('pageTitleText'),
            countText: document.getElementById('channelCount'),
            loading: document.getElementById('loadingState'),
            empty: document.getElementById('emptyState'),
            loadMore: document.getElementById('loadMoreContainer'),

            // Player State
            currentChannel: null,
            loadTimeout: null,
            stallTimeout: null, // New: track buffering stalls
        };

        // --- Initialization ---
        async function init() {
            lucide.createIcons();
            document.getElementById('loadingText').innerText = "Fetching Channel Directory...";

            try {
                // Fetch all data in parallel
                const [catRes, countryRes, streamRes, chanRes, logoRes, langRes] = await Promise.all([
                    fetch('https://iptv-org.github.io/api/categories.json'),
                    fetch('https://iptv-org.github.io/api/countries.json'),
                    fetch('https://iptv-org.github.io/api/streams.json'),
                    fetch('https://iptv-org.github.io/api/channels.json'),
                    fetch('https://iptv-org.github.io/api/logos.json'),
                    fetch('https://iptv-org.github.io/api/languages.json')
                ]);

                document.getElementById('loadingText').innerText = "Processing Data...";

                const categories = await catRes.json();
                const countries = await countryRes.json();
                const streams = await streamRes.json();
                const channels = await chanRes.json();
                const logos = await logoRes.json();
                const languages = await langRes.json();

                state.categories = categories;
                state.countries = countries;
                state.languages = languages;

                // --- Data Processing ---
                
                // Maps for O(1) lookups
                const channelMap = new Map(channels.map(c => [c.id, c]));
                const logoMap = new Map();
                logos.forEach(l => {
                    if (!logoMap.has(l.channel)) logoMap.set(l.channel, l.url);
                });
                const countryLangMap = new Map(countries.map(c => [c.code, c.languages || []]));
                const countryNameMap = new Map(countries.map(c => [c.code, c.name]));
                const langNameMap = new Map(languages.map(l => [l.code, l.name]));

                const processedChannels = [];
                const addedIds = new Set();

                for (const stream of streams) {
                    if (!stream.channel) continue;
                    
                    // Deduplicate
                    if (addedIds.has(stream.channel)) continue;

                    const metadata = channelMap.get(stream.channel);
                    
                    if (metadata) {
                        // XXX Filter (Remove NSFW)
                        if (metadata.is_nsfw) continue;

                        const logo = logoMap.get(stream.channel) || metadata.logo;
                        
                        // Determine Languages: use explicit channel langs, or fallback to country langs
                        let channelLangs = metadata.languages || [];
                        if (channelLangs.length === 0 && metadata.country) {
                             channelLangs = countryLangMap.get(metadata.country) || [];
                        }

                        // Resolve full names for metadata usage
                        const countryName = countryNameMap.get(metadata.country) || metadata.country || 'Unknown';
                        const firstLangCode = channelLangs[0];
                        const langName = langNameMap.get(firstLangCode) || (firstLangCode ? firstLangCode.toUpperCase() : 'Unknown');

                        processedChannels.push({
                            id: stream.channel,
                            name: metadata.name || stream.channel,
                            logo: logo,
                            country: metadata.country,
                            countryName: countryName,
                            category: metadata.categories?.[0] || 'Uncategorized',
                            languages: channelLangs, // Array of ISO codes
                            langName: langName, // Primary readable language
                            streamUrl: stream.url,
                            website: metadata.website
                        });
                        addedIds.add(stream.channel);
                    }
                }

                state.channels = processedChannels;

                // --- Render Sidebar ---
                renderSidebar();

                // --- Initial Render (India) ---
                applyFilters();

                state.loading.classList.add('hidden');

            } catch (error) {
                console.error(error);
                document.getElementById('loadingText').innerText = "Error loading data. Please refresh.";
                document.getElementById('loadingText').classList.add('text-red-500');
            }
        }

        // --- Render Logic ---

        function renderSidebar() {
            // Render Genres (Categories)
            const genreList = document.getElementById('genresList');
            let genreHtml = '';
            state.categories.sort((a,b) => a.name.localeCompare(b.name)).forEach(cat => {
                genreHtml += `
                    <button onclick="setFilter('category', '${cat.id}')" id="nav-cat-${cat.id}" class="w-full flex items-center gap-3 px-3 py-2 rounded-lg text-sm font-medium transition-all text-neutral-400 hover:bg-white/5 hover:text-white group">
                        <span class="truncate">${cat.name}</span>
                    </button>
                `;
            });
            genreList.innerHTML = genreHtml;

            // Render Languages
            const langList = document.getElementById('languagesList');
            let langHtml = '';
            
            // Find all unique languages present in channels
            const activeLangCodes = new Set();
            state.channels.forEach(c => c.languages.forEach(l => activeLangCodes.add(l)));
            
            // Filter all available languages by active codes, then sort
            const activeLanguages = state.languages
                .filter(l => activeLangCodes.has(l.code))
                .sort((a,b) => a.name.localeCompare(b.name));

            activeLanguages.forEach(lang => {
                 langHtml += `
                    <button onclick="setFilter('language', '${lang.code}')" id="nav-lang-${lang.code}" class="w-full flex items-center gap-3 px-3 py-2 rounded-lg text-sm font-medium transition-all text-neutral-400 hover:bg-white/5 hover:text-white group">
                        <span class="truncate">${lang.name}</span>
                    </button>
                `;
            });
            langList.innerHTML = langHtml;

            // Render Countries (Exclude featured ones)
            const countryList = document.getElementById('countriesList');
            let countryHtml = '';
            const featured = ['IN', 'US', 'UK'];
            const sortedCountries = state.countries.filter(c => !featured.includes(c.code)).sort((a,b) => a.name.localeCompare(b.name));
            
            sortedCountries.forEach(country => {
                 countryHtml += `
                    <button onclick="setFilter('country', '${country.code}')" id="nav-country-${country.code}" class="w-full flex items-center gap-3 px-3 py-2 rounded-lg text-sm font-medium transition-all text-neutral-400 hover:bg-white/5 hover:text-white group">
                        <span class="text-lg w-5 text-center">${country.flag}</span>
                        <span class="truncate">${country.name}</span>
                    </button>
                `;
            });
            countryList.innerHTML = countryHtml;

            lucide.createIcons();
        }

        function getFilteredData() {
            let data = state.channels;
            const q = state.searchQuery.toLowerCase();

            // 1. Filter by Tab logic
            if (state.activeTab === 'favorites') {
                data = data.filter(c => state.favorites.includes(c.id));
            } else if (state.activeTab === 'country') {
                if (state.filterValue) {
                    data = data.filter(c => c.country === state.filterValue);
                }
            } else if (state.activeTab === 'category') {
                if (state.filterValue) {
                    data = data.filter(c => c.category === state.filterValue);
                }
            } else if (state.activeTab === 'language') {
                if (state.filterValue) {
                    data = data.filter(c => c.languages.includes(state.filterValue));
                }
            }

            // 2. Filter by Search
            if (q) {
                data = data.filter(c => c.name.toLowerCase().includes(q));
            }

            return data;
        }

        function applyFilters() {
            updateActiveNav();
            const results = getFilteredData();
            
            // Update Header Text
            let title = 'Channels';
            if (state.activeTab === 'favorites') title = 'My Favorites';
            else if (state.activeTab === 'all') title = 'All Channels';
            else if (state.activeTab === 'country') {
                const cObj = state.countries.find(c => c.code === state.filterValue);
                title = cObj ? `${cObj.name} Channels` : 'Country Channels';
            } else if (state.activeTab === 'category') {
                const cObj = state.categories.find(c => c.id === state.filterValue);
                title = cObj ? `${cObj.name} Genre` : 'Genre';
            } else if (state.activeTab === 'language') {
                const lObj = state.languages.find(l => l.code === state.filterValue);
                title = lObj ? `${lObj.name} Channels` : 'Language';
            }

            state.titleText.innerText = title;
            state.countText.innerText = `Found ${results.length} channels`;
            state.displayLimit = 60;
            renderGrid(results);
        }

        function renderGrid(data) {
            const grid = state.grid;
            grid.innerHTML = '';

            if (data.length === 0) {
                state.empty.classList.remove('hidden');
                state.loadMore.classList.add('hidden');
                return;
            } else {
                state.empty.classList.add('hidden');
            }

            const slice = data.slice(0, state.displayLimit);

            slice.forEach(channel => {
                const isFav = state.favorites.includes(channel.id);
                const firstLetter = channel.name.charAt(0).toUpperCase();
                const logoHtml = channel.logo 
                    ? `<img src="${channel.logo}" alt="${channel.name}" loading="lazy" class="relative z-10 max-h-full max-w-full object-contain drop-shadow-md group-hover:scale-110 transition-transform duration-500" onerror="this.style.display='none';this.nextElementSibling.style.display='flex'">
                       <div class="hidden relative z-10 w-12 h-12 rounded-full bg-neutral-800 flex items-center justify-center text-neutral-500 font-bold text-xl">${firstLetter}</div>` 
                    : `<div class="relative z-10 w-12 h-12 rounded-full bg-neutral-800 flex items-center justify-center text-neutral-500 font-bold text-xl group-hover:bg-emerald-500 group-hover:text-white transition-colors">${firstLetter}</div>`;

                const card = document.createElement('div');
                card.className = "group relative bg-neutral-900 border border-white/5 rounded-2xl overflow-hidden cursor-pointer hover:border-emerald-500/30 hover:shadow-2xl hover:shadow-emerald-900/10 transition-all duration-300 hover:-translate-y-1";
                // Pass full object for info modal
                card.onclick = () => playChannel(channel);
                
                card.innerHTML = `
                    <div class="aspect-[16/9] bg-neutral-950/50 relative flex items-center justify-center p-6">
                        <div class="absolute inset-0 bg-gradient-to-t from-neutral-900 to-transparent opacity-50"></div>
                        ${logoHtml}
                        <div class="absolute inset-0 z-20 bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex items-center justify-center backdrop-blur-[2px]">
                            <div class="bg-emerald-500 text-white rounded-full p-3 shadow-lg transform scale-50 group-hover:scale-100 transition-all duration-300">
                                <i data-lucide="play" class="w-5 h-5 fill-current ml-0.5"></i>
                            </div>
                        </div>
                        <button onclick="toggleFavorite(event, '${channel.id}')" class="absolute top-2 right-2 p-2 rounded-full z-30 transition-all duration-200 ${isFav ? 'text-red-500 bg-white/10 opacity-100' : 'text-neutral-400 hover:text-white bg-black/20 opacity-0 group-hover:opacity-100'}">
                            <i data-lucide="heart" class="w-4 h-4 ${isFav ? 'fill-current' : ''}"></i>
                        </button>
                        ${channel.country ? `<div class="absolute top-2 left-2 z-20 text-[10px] bg-black/60 backdrop-blur-sm text-neutral-300 px-2 py-0.5 rounded-md font-mono border border-white/5">${channel.country}</div>` : ''}
                    </div>
                    <div class="p-4 bg-neutral-900">
                        <h3 class="font-semibold text-sm truncate text-neutral-200 group-hover:text-emerald-400 transition-colors">${channel.name}</h3>
                        <div class="flex items-center gap-2 mt-1">
                            <span class="w-1.5 h-1.5 rounded-full bg-emerald-500"></span>
                            <p class="text-xs text-neutral-500 truncate capitalize">${channel.category}</p>
                        </div>
                    </div>
                `;
                grid.appendChild(card);
            });
            lucide.createIcons();
            if (state.displayLimit < data.length) state.loadMore.classList.remove('hidden');
            else state.loadMore.classList.add('hidden');
        }

        // --- Interactions ---

        function setFilter(tab, val = null) {
            state.activeTab = tab;
            state.filterValue = val;
            state.searchQuery = ''; 
            document.getElementById('searchInputDesktop').value = '';
            document.getElementById('searchInputMobile').value = '';
            document.getElementById('sidebar').classList.add('-translate-x-full');
            applyFilters();
        }

        function loadMoreChannels() {
            state.displayLimit += 60;
            const results = getFilteredData();
            renderGrid(results);
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            if (sidebar.classList.contains('-translate-x-full')) sidebar.classList.remove('-translate-x-full');
            else sidebar.classList.add('-translate-x-full');
        }

        function toggleAccordion(id) {
            const content = document.getElementById(id);
            const icon = document.getElementById('icon-' + id);
            
            if (content.classList.contains('open')) {
                content.classList.remove('open');
                icon.style.transform = 'rotate(0deg)';
            } else {
                content.classList.add('open');
                icon.style.transform = 'rotate(180deg)';
            }
        }

        function toggleFavorite(e, id) {
            e.stopPropagation();
            const index = state.favorites.indexOf(id);
            if (index === -1) state.favorites.push(id);
            else state.favorites.splice(index, 1);
            localStorage.setItem('takaTV_favorites', JSON.stringify(state.favorites));
            applyFilters();
        }

        function updateActiveNav() {
            // Helper to reset and set styles
            const reset = (id) => {
                const el = document.getElementById(id);
                if(el) el.className = "w-full flex items-center gap-3 px-3 py-2 rounded-lg text-sm font-medium transition-all text-neutral-400 hover:bg-white/5 hover:text-white group";
            };
            const setActive = (id) => {
                const el = document.getElementById(id);
                if(el) el.className = "w-full flex items-center gap-3 px-3 py-2 rounded-lg text-sm font-medium transition-all bg-emerald-500 text-white shadow-lg shadow-emerald-500/20";
            };

            document.querySelectorAll('#sidebar button').forEach(btn => {
                if(btn.id.startsWith('nav-')) {
                   btn.className = "w-full flex items-center gap-3 px-3 py-2 rounded-lg text-sm font-medium transition-all text-neutral-400 hover:bg-white/5 hover:text-white group";
                }
            });
            
            const navAll = document.getElementById('nav-all');
            const navFav = document.getElementById('nav-favorites');
            if(navAll) navAll.classList.replace('py-2', 'py-2.5');
            if(navFav) navFav.classList.replace('py-2', 'py-2.5');

            if (state.activeTab === 'all') setActive('nav-all');
            else if (state.activeTab === 'favorites') setActive('nav-favorites');
            else if (state.activeTab === 'country') setActive(`nav-country-${state.filterValue}`);
            else if (state.activeTab === 'category') setActive(`nav-cat-${state.filterValue}`);
            else if (state.activeTab === 'language') setActive(`nav-lang-${state.filterValue}`);
            
            const favBtn = document.getElementById('headerFavBtn');
            if (state.activeTab === 'favorites') {
                favBtn.className = "p-2 rounded-full transition-all duration-300 bg-red-500/20 text-red-500 scale-110";
                favBtn.innerHTML = '<i data-lucide="heart" class="w-5 h-5 fill-current"></i>';
            } else {
                favBtn.className = "p-2 rounded-full transition-all duration-300 text-neutral-400 hover:text-red-400 hover:bg-neutral-800";
                favBtn.innerHTML = '<i data-lucide="heart" class="w-5 h-5"></i>';
            }
            lucide.createIcons();
        }

        // --- Search Listeners ---
        const handleSearch = (e) => {
            state.searchQuery = e.target.value;
            state.displayLimit = 60;
            applyFilters();
        };
        document.getElementById('searchInputDesktop').addEventListener('input', handleSearch);
        document.getElementById('searchInputMobile').addEventListener('input', handleSearch);

        // --- Video Player Logic ---
        let hls = null;

        function playChannel(channel) {
            state.currentChannel = channel; // Save for retry
            const modal = document.getElementById('videoModal');
            const video = document.getElementById('videoPlayer');
            const nameEl = document.getElementById('playerChannelName');
            const errorEl = document.getElementById('playerError');
            const loaderEl = document.getElementById('playerLoader');
            
            // Set Info Fields
            document.getElementById('infoCountry').innerText = channel.countryName;
            document.getElementById('infoLang').innerText = channel.langName;
            document.getElementById('infoCategory').innerText = channel.category;
            
            // Reset UI
            modal.classList.remove('hidden');
            errorEl.classList.add('hidden');
            loaderEl.classList.remove('hidden'); // Show loader immediately
            document.getElementById('playerInfoCard').classList.add('hidden');
            document.getElementById('playerInfoCard').classList.remove('opacity-100');
            nameEl.innerText = channel.name;
            
            // Reset Live Dot
            const dot = document.getElementById('liveDot');
            dot.classList.remove('bg-red-500', 'live-glow');
            dot.classList.add('bg-neutral-500');
            
            // Cleanup timers
            if (state.loadTimeout) clearTimeout(state.loadTimeout);
            if (state.stallTimeout) clearTimeout(state.stallTimeout);

            // 1. HARD TIMEOUT: If nothing plays in 15s, kill it.
            state.loadTimeout = setTimeout(() => {
                // If loader is still visible OR video time is 0
                if (!loaderEl.classList.contains('hidden') || video.currentTime === 0) {
                    showError('Timeout', 'Connection timed out. The stream is taking too long to respond.');
                }
            }, 15000);

            // 2. STALL DETECTION: Monitor native video events
            video.onwaiting = () => {
                loaderEl.classList.remove('hidden'); // Show spinner when buffering
                // If we stall for more than 15s during playback
                if (state.stallTimeout) clearTimeout(state.stallTimeout);
                state.stallTimeout = setTimeout(() => {
                     showError('Stall', 'Stream stopped sending data.');
                }, 15000);
            };

            video.onplaying = () => {
                loaderEl.classList.add('hidden'); // Hide spinner ONLY when actually playing
                // Clear all failure timers
                if (state.loadTimeout) clearTimeout(state.loadTimeout);
                if (state.stallTimeout) clearTimeout(state.stallTimeout);
                checkLiveStatus();
            };

            // Initialize Source
            if (Hls.isSupported()) {
                if (hls) hls.destroy();
                hls = new Hls({
                    manifestLoadingTimeOut: 10000,
                    levelLoadingTimeOut: 10000,
                    fragLoadingTimeOut: 10000,
                    startFragPrefetch: true // Try to fetch start fragment immediately
                });

                hls.loadSource(channel.streamUrl);
                hls.attachMedia(video);
                
                hls.on(Hls.Events.MANIFEST_PARSED, () => {
                    video.play().catch(e => console.log("Autoplay blocked", e));
                    // REMOVED: loaderEl.classList.add('hidden'); -> We wait for 'playing' event now
                });

                hls.on(Hls.Events.ERROR, (event, data) => {
                    if (data.fatal) {
                        switch (data.type) {
                            case Hls.ErrorTypes.NETWORK_ERROR:
                                console.log("Network error, trying to recover...");
                                hls.startLoad();
                                break;
                            case Hls.ErrorTypes.MEDIA_ERROR:
                                console.log("Media error, trying to recover...");
                                hls.recoverMediaError();
                                break;
                            default:
                                showError(data.type, data.details);
                                hls.destroy();
                                break;
                        }
                    }
                });
            }
            else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                video.src = channel.streamUrl;
                video.addEventListener('loadedmetadata', () => {
                    video.play();
                    // Native player 'playing' event will handle loader hiding
                });
                video.addEventListener('error', (e) => {
                    showError('NativeError', `Code: ${video.error ? video.error.code : 'Unknown'}`);
                });
            }
        }
        
        function showError(type, details) {
            const errorEl = document.getElementById('playerError');
            const loaderEl = document.getElementById('playerLoader');
            const descEl = document.getElementById('errorDescription');
            const techEl = document.getElementById('errorTechnical');
            const video = document.getElementById('videoPlayer');
            
            // Kill timers and playback
            if (state.loadTimeout) clearTimeout(state.loadTimeout);
            if (state.stallTimeout) clearTimeout(state.stallTimeout);
            video.pause();

            loaderEl.classList.add('hidden');
            errorEl.classList.remove('hidden');
            
            // Set the "Paid Access" message for all errors as requested
            descEl.innerText = "This channel requires paid access so we have blocked this stream.";

            // Keep technical details for debugging but hide them behind the "Paid" facade
            techEl.innerText = `Error: ${type} (${details || 'Unknown'})`;
        }

        function retryStream() {
            if (state.currentChannel) {
                playChannel(state.currentChannel);
            }
        }
        
        function copyErrorDetails() {
            const text = document.getElementById('errorTechnical').innerText;
            navigator.clipboard.writeText(text);
            const btn = document.querySelector('#playerError button[onclick="copyErrorDetails()"]');
            const originalText = btn.innerText;
            btn.innerText = "Copied!";
            setTimeout(() => btn.innerText = originalText, 2000);
        }

        // Check if stream is live to animate button
        function checkLiveStatus() {
            const video = document.getElementById('videoPlayer');
            const dot = document.getElementById('liveDot');
            const loaderEl = document.getElementById('playerLoader');

            // Clear loader if playing
            if (!video.paused) loaderEl.classList.add('hidden');
            
            // Simple check: Infinity duration often means live in native players, 
            // or HLS liveSyncPosition
            setTimeout(() => {
                if (video.duration === Infinity || (hls && hls.liveSyncPosition)) {
                     dot.classList.remove('bg-neutral-500');
                     dot.classList.add('bg-red-500', 'live-glow');
                }
            }, 2000);
        }

        function syncLive() {
             const video = document.getElementById('videoPlayer');
             if (hls && hls.liveSyncPosition) {
                 video.currentTime = hls.liveSyncPosition;
             } else if (video.seekable.length > 0) {
                 video.currentTime = video.seekable.end(0);
             }
        }

        function toggleFullscreen() {
            const container = document.getElementById('playerContainer');
            if (!document.fullscreenElement) {
                container.requestFullscreen().catch(err => {
                    console.log(`Error attempting to enable fullscreen: ${err.message}`);
                });
            } else {
                document.exitFullscreen();
            }
        }
        
        function toggleInfo() {
            const card = document.getElementById('playerInfoCard');
            const title = document.getElementById('playerChannelName'); // The header title
            
            // We are using the header title for the card now, so we just toggle card visibility
            if (card.classList.contains('hidden')) {
                card.classList.remove('hidden');
                // Small delay to allow display block to apply before opacity transition
                setTimeout(() => card.classList.add('opacity-100'), 10);
            } else {
                card.classList.remove('opacity-100');
                setTimeout(() => card.classList.add('hidden'), 300);
            }
        }

        function closePlayer() {
            const modal = document.getElementById('videoModal');
            const video = document.getElementById('videoPlayer');
            
            // Clean up all timers
            if (state.loadTimeout) clearTimeout(state.loadTimeout);
            if (state.stallTimeout) clearTimeout(state.stallTimeout);
            video.onwaiting = null;
            video.onplaying = null;
            
            video.pause();
            video.src = '';
            if (hls) hls.destroy();
            modal.classList.add('hidden');
            
            if (document.fullscreenElement) {
                document.exitFullscreen();
            }
        }

        window.addEventListener('DOMContentLoaded', init);

    </script>
</body>
</html>


