<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TAKA AI Control Panel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white p-4">
  <h1 class="text-3xl font-bold mb-6">TAKA AI Control Panel</h1>

  <div id="adminContent" style="display:none;">
    <div id="formArea" class="mb-6">
      <input id="modeName" placeholder="Mode Name" class="w-full p-2 mb-2 rounded bg-gray-800 border border-gray-600" />
      <input id="modeDesc" placeholder="Mode Description" class="w-full p-2 mb-2 rounded bg-gray-800 border border-gray-600" />
      <select id="modeModel" class="w-full p-2 mb-2 rounded bg-gray-800 border border-gray-600">
        <option value="">Select a model...</option>

        <!-- 1. Free models (from Chutes) -->
        <optgroup label="Chutes / Free">
          <option value="deepseek-ai/DeepSeek-V3-0324">DeepSeek V3â€‘0324</option>
          <option value="deepseek-ai/DeepSeek-V3-Base">DeepSeek V3â€‘Base</option>
          <option value="deepseek-ai/DeepSeek-R1">DeepSeek R1</option>
          <option value="chutesai/Llama-4-Maverick-17B-128E-Instruct-FP8">Llamaâ€‘4 Maverick 17B</option>
          <option value="chutesai/Mistral-Small-3.1-24B-Instruct-2503">Mistralâ€‘Small 24B Instruct</option>
          <option value="unsloth/gemma-3-12b-it">Gemmaâ€‘3 12B Multilingual</option>
          <option value="moonshotai131K/Kimi-Dev-72B">Kimiâ€‘Dev 72B</option>
          <option value="sarvam-ai/Sarvam-M">Sarvamâ€‘M (24B Indic)</option>
        </optgroup>

        <!-- 2. Paid/OpenAI/Other Tier -->
        <optgroup label="Paid / Premium">
          <option value="google/gemini-2.5-pro">Geminiâ€¯2.5 Pro</option>
          <option value="anthropic/claude-4-opus">Claudeâ€¯4 Opus</option>
          <option value="openai/gpt-4.5">GPTâ€‘4.5</option>
        </optgroup>
      </select>

      <input type="hidden" id="modeCategory" value="free" />

      <button id="saveBtn" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded">Save Mode</button>
      <button id="cancelBtn" class="bg-gray-600 hover:bg-gray-700 px-4 py-2 rounded ml-2">Cancel</button>
    </div>

    <h2 class="text-xl font-semibold mb-2">Test Mode (Chutes AI)</h2>
    <div class="mb-6">
      <textarea id="testInput" rows="3" placeholder="Enter test promptâ€¦" class="w-full p-2 mb-2 rounded bg-gray-800 border border-gray-600"></textarea>
      <button id="runBtn" class="bg-indigo-600 hover:bg-indigo-700 px-4 py-2 rounded">Run Model</button>
      <pre id="testOutput" class="mt-3 p-2 bg-gray-800 rounded max-h-48 overflow-y-auto"></pre>
    </div>

    <h2 class="text-xl font-semibold mb-2">All Modes</h2>
    <div id="modeList" class="space-y-2"></div>
  </div>

  <div id="accessDenied" class="hidden text-center mt-10 text-red-500 text-xl font-bold">ðŸš« Access Denied. Admins only.</div>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    const SUPA_URL = 'https://vmronlbzksuiikspvlvz.supabase.co';
    const SUPA_KEY = 'eyJhbGciOiJ...RSCsmSM';
    const CHUTES_API_URL = 'https://llm.chutes.ai/v1/chat/completions';
    const CHUTES_API_KEY = 'cpk_c8adcf5e163e46a1ae61782a72e6f36b.2fe6509bc2a35be39e98a9a6f4b42a5b.ftzjgQW9VwL0nFdZkXBGdHDUi6NsAEAJ';

    const supabase = createClient(SUPA_URL, SUPA_KEY);

    const nameInput = document.getElementById('modeName');
    const descInput = document.getElementById('modeDesc');
    const modelSelect = document.getElementById('modeModel');
    const categoryInput = document.getElementById('modeCategory');
    const saveBtn = document.getElementById('saveBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    const modeList = document.getElementById('modeList');

    const runBtn = document.getElementById('runBtn');
    const testInput = document.getElementById('testInput');
    const testOutput = document.getElementById('testOutput');

    const adminContent = document.getElementById('adminContent');
    const accessDenied = document.getElementById('accessDenied');
    let editingId = null;

    modelSelect.onchange = () =>
      categoryInput.value = modelSelect.value.includes('/') && modelSelect.value.startsWith('deepseek')
        ? 'free' : modelSelect.value.startsWith('chutesai') ? 'free' : 'paid';

    // Auth Check
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) return window.location.href = "/login.html";

    const { data: admin } = await supabase.from('admins').select('id').eq('id', user.id).single();
    if (!admin) {
      accessDenied.classList.remove('hidden');
      throw new Error("Access denied");
    }
    adminContent.style.display = 'block';

    // Load all modes
    async function loadModes() {
      const { data: modes } = await supabase.from('modes').select('*').order('id', { ascending: false });
      modeList.innerHTML = '';
      modes.forEach(m => {
        const badge = `<span class="ml-2 text-xs font-semibold ${m.category === 'free' ? 'text-green-400' : 'text-red-400'}">[${m.category.toUpperCase()}]</span>`;
        const div = document.createElement('div');
        div.className = 'p-3 rounded bg-gray-800 border border-gray-700 flex justify-between items-center';
        div.innerHTML = `
          <div>${m.name} ${badge}<br/><span class="text-sm text-gray-400">${m.description}</span><br/>
            <span class="text-sm text-gray-500">Model: ${m.model}</span>
          </div>
          <div>
            <button data-id="${m.id}" class="deleteBtn bg-red-600 hover:bg-red-700 px-2 py-1 rounded text-sm">Delete</button>
          </div>`;
        modeList.appendChild(div);
      });
      document.querySelectorAll('.deleteBtn').forEach(b => b.onclick = async () =>
        await supabase.from('modes').delete().eq('id', b.dataset.id).then(loadModes));
    }
    loadModes();

    // Save/Edit Mode
    saveBtn.onclick = async () => {
      const name = nameInput.value.trim();
      const desc = descInput.value.trim();
      const model = modelSelect.value;
      const category = categoryInput.value;
      if (!name||!desc||!model) return alert("Fill all fields");

      const payload = { name, description: desc, model, category, enabled: true };
      if (editingId) {
        await supabase.from('modes').update(payload).eq('id', editingId);
        editingId = null;
      } else {
        await supabase.from('modes').insert([payload]);
      }
      nameInput.value = '';
      descInput.value = '';
      modelSelect.value = '';
      categoryInput.value = 'free';
      loadModes();
    };

    cancelBtn.onclick = () => {
      nameInput.value = '';
      descInput.value = '';
      modelSelect.value = '';
      categoryInput.value = 'free';
      editingId = null;
    };

    // Run Chutes AI model  
    runBtn.onclick = async () => {
      if (!modelSelect.value) return alert("Select model!");
      const res = await fetch(CHUTES_API_URL, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${CHUTES_API_KEY}`
        },
        body: JSON.stringify({
          model: modelSelect.value,
          messages: [{role:'user',content:testInput.value}],
          stream: false
        })
      });
      const json = await res.json();
      testOutput.textContent = json.choices?.[0]?.message?.content || JSON.stringify(json, null, 2);
    };
  </script>
</body>
</html>
