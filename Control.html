<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TAKA AI Control Panel</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-gray-900 p-6">
  <h1 class="text-3xl font-bold mb-4">TAKA AI Control Panel</h1>

  <!-- Toggle Buttons -->
  <div class="mb-4 flex gap-2">
    <button onclick="showSection('modes')" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded">Modes</button>
    <button onclick="showSection('chats')" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded">View User Chats</button>
  </div>

  <!-- Mode Section -->
  <div id="modesSection">
    <div class="mb-4">
      <input id="newModeName" placeholder="Mode Name" class="border p-2 rounded w-1/3" />
      <input id="newModeDesc" placeholder="Personality/Description" class="border p-2 rounded w-1/3" />
      <button onclick="addMode()" class="bg-blue-600 text-white px-4 py-2 rounded">Add Mode</button>
    </div>
    <div id="modesList" class="space-y-2"></div>
  </div>

  <!-- Chats Section -->
  <div id="chatsSection" class="hidden">
    <div id="chatsList" class="space-y-4 max-h-[600px] overflow-y-auto p-2 bg-white shadow rounded"></div>
  </div>

  <script>
    const SUPABASE_URL = "https://vmronlbzksuiikspvlvz.supabase.co";
    const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZtcm9ubGJ6a3N1aWlrc3B2bHZ6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk5ODMwNTcsImV4cCI6MjA2NTU1OTA1N30.WMKbpJn1aavkwQDmsYq_-4EMSLL9tc4LexpmRSCsmSM";
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

    async function loadModes() {
      const { data } = await supabase.from("modes").select("*").order("id", { ascending: false });
      const list = document.getElementById("modesList");
      list.innerHTML = "";
      data.forEach(mode => {
        const item = document.createElement("div");
        item.className = "bg-white p-4 rounded shadow flex justify-between items-center";
        item.innerHTML = `
          <div>
            <strong>${mode.name}</strong><br/>
            <small>${mode.description}</small><br/>
            <small>Status: ${mode.enabled ? "✅ Enabled" : "❌ Disabled"}</small>
          </div>
          <div class="flex gap-2">
            <button onclick="toggleMode(${mode.id}, ${!mode.enabled})" class="text-sm bg-yellow-400 px-2 py-1 rounded">${mode.enabled ? "Disable" : "Enable"}</button>
            <button onclick="deleteMode(${mode.id})" class="text-sm bg-red-500 text-white px-2 py-1 rounded">Delete</button>
          </div>
        `;
        list.appendChild(item);
      });
    }

    async function addMode() {
      const name = document.getElementById("newModeName").value.trim();
      const description = document.getElementById("newModeDesc").value.trim();
      if (!name || !description) return alert("Enter both name and description");
      const { error } = await supabase.from("modes").insert([{ name, description, enabled: true }]);
      if (error) return alert("Failed to add mode: " + error.message);
      document.getElementById("newModeName").value = "";
      document.getElementById("newModeDesc").value = "";
      loadModes();
    }

    async function toggleMode(id, enabled) {
      await supabase.from("modes").update({ enabled }).eq("id", id);
      loadModes();
    }

    async function deleteMode(id) {
      if (confirm("Delete this mode?")) {
        await supabase.from("modes").delete().eq("id", id);
        loadModes();
      }
    }

    async function loadChats() {
      const { data } = await supabase.from("chats").select("*").order("timestamp", { ascending: false }).limit(100);
      const list = document.getElementById("chatsList");
      list.innerHTML = "";
      data.forEach(chat => {
        const item = document.createElement("div");
        item.className = "p-3 border-b";
        item.innerHTML = `
          <strong>User:</strong> ${chat.user_id || "Anonymous"}<br/>
          <strong>Type:</strong> ${chat.type}<br/>
          <strong>Time:</strong> ${new Date(chat.timestamp).toLocaleString()}<br/>
          <strong>Message:</strong> ${chat.message}
        `;
        list.appendChild(item);
      });
    }

    function showSection(section) {
      document.getElementById("modesSection").classList.toggle("hidden", section !== "modes");
      document.getElementById("chatsSection").classList.toggle("hidden", section !== "chats");
      if (section === "modes") loadModes();
      if (section === "chats") loadChats();
    }

    // Load on start
    loadModes();
  </script>
</body>
</html>
