<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TakaGalaxy Chat</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    /* ... (all your existing styles remain unchanged) ... */
  </style>
</head>
<body>
  <!-- ... (all your existing HTML structure remains unchanged) ... -->

  <script>
    // Initialize Supabase
    const supabase = window.supabase.createClient(
      'https://vmronlbzksuiikspvlvz.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZtcm9ubGJ6a3N1aWlrc3B2bHZ6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk5ODMwNTcsImV4cCI6MjA2NTU1OTA1N30.WMKbpJn1aavkwQDmsYq_-4EMSLL9tc4LexpmRSCsmSM'
    );
    
    // Global state
    let currentUser = null;
    let selectedUser = null;
    let usernameSet = false;
    let allUsers = [];
    let messagePolling = null;
    
    // DOM Elements
    const usernameModal = document.getElementById('usernameModal');
    const usernameInput = document.getElementById('usernameInput');
    const usernameError = document.getElementById('usernameError');
    const userAvatar = document.getElementById('userAvatar');
    const userName = document.getElementById('userName');
    const userStatus = document.getElementById('userStatus');
    const userList = document.getElementById('userList');
    const chatHeader = document.getElementById('chatHeader');
    const messagesContainer = document.getElementById('messagesContainer');
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const typingIndicator = document.getElementById('typingIndicator');
    const userSearch = document.getElementById('userSearch');
    
    // Initialize the application
    async function initApp() {
      try {
        // Check auth status
        const { data: { user }, error: authError } = await supabase.auth.getUser();
        
        if (authError) {
          console.error('Auth error:', authError);
          window.location.href = 'index.html';
          return;
        }
        
        if (!user) {
          window.location.href = 'index.html';
          return;
        }
        
        currentUser = user;
        
        // Set user avatar with first letter of email
        const firstLetter = user.email ? user.email.charAt(0).toUpperCase() : 'U';
        userAvatar.innerHTML = firstLetter;
        
        // Check if username is set
        await checkUsername();
        
        // Load other users
        await loadUsers();
        
        // Set up event listeners
        setupEventListeners();
        
        // Set user status to online
        updateUserStatus(true);
      } catch (error) {
        console.error('Initialization error:', error);
      }
    }
    
    // Check if username is set
    async function checkUsername() {
      try {
        const { data, error } = await supabase
          .from('profiles')
          .select('username')
          .eq('id', currentUser.id)
          .single();
          
        if (error || !data || !data.username) {
          usernameModal.style.display = 'flex';
          userName.textContent = 'Guest';
        } else {
          usernameSet = true;
          userName.textContent = data.username;
          usernameModal.style.display = 'none';
        }
      } catch (error) {
        console.error('Username check error:', error);
        usernameModal.style.display = 'flex';
      }
    }
    
    // Set username - FIXED VERSION
    async function setUsername() {
      const username = usernameInput.value.trim();
      
      // Reset error message
      usernameError.classList.add('hidden');
      
      // Validate username length
      if (username.length < 3 || username.length > 20) {
        usernameError.textContent = 'Username must be 3-20 characters';
        usernameError.classList.remove('hidden');
        return;
      }
      
      try {
        // 1. Check if username is available
        const { data: existingUsers, error: checkError } = await supabase
          .from('profiles')
          .select('id')
          .eq('username', username);
          
        if (checkError) {
          throw new Error(`Username check failed: ${checkError.message}`);
        }
        
        // Check if username is taken by someone else
        const isTaken = existingUsers.some(user => 
          user.id !== currentUser.id && user.username === username
        );
        
        if (isTaken) {
          usernameError.textContent = 'Username already taken';
          usernameError.classList.remove('hidden');
          return;
        }
        
        // 2. Save username to profiles table
        const { error: upsertError } = await supabase
          .from('profiles')
          .upsert({
            id: currentUser.id,
            username: username,
            email: currentUser.email,
            status: 'online'
          }, {
            onConflict: 'id'  // Update existing user if found
          });
          
        if (upsertError) {
          throw new Error(`Username save failed: ${upsertError.message}`);
        }
        
        // 3. Update UI
        usernameSet = true;
        userName.textContent = username;
        usernameModal.style.display = 'none';
        
        // 4. Reload users to show the new username
        await loadUsers();
      } catch (error) {
        console.error('Username set error:', error);
        usernameError.textContent = 'Error saving username. Please try again.';
        usernameError.classList.remove('hidden');
        
        // Detailed debugging
        const debugInfo = document.createElement('div');
        debugInfo.className = 'text-red-300 text-xs mt-2';
        debugInfo.textContent = `Debug: ${error.message}`;
        usernameError.parentNode.appendChild(debugInfo);
      }
    }
    
    // Load other users
    async function loadUsers() {
      try {
        const { data: users, error } = await supabase
          .from('profiles')
          .select('id, username, email, status')
          .neq('id', currentUser.id);
          
        if (error) {
          throw error;
        }
        
        // Store all users for search
        allUsers = users || [];
        
        // Render users
        renderUsers(allUsers);
      } catch (error) {
        console.error('User load error:', error);
        userList.innerHTML = `
          <div class="no-users">
            <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
            <p>Error loading users</p>
            <p class="text-xs mt-1">${error.message}</p>
          </div>
        `;
      }
    }
    
    // Render users to the UI
    function renderUsers(users) {
      userList.innerHTML = '';
      
      if (!users || users.length === 0) {
        userList.innerHTML = `
          <div class="no-users">
            <i class="fas fa-user-slash text-2xl mb-2"></i>
            <p>No users found</p>
          </div>
        `;
        return;
      }
      
      users.forEach(user => {
        if (!user.username) return;
        
        const userElement = document.createElement('div');
        userElement.className = 'user-card p-3 rounded-lg mb-1 flex items-center transition-colors';
        userElement.innerHTML = `
          <div class="w-10 h-10 rounded-full bg-gradient-to-r from-amber-500 to-orange-500 flex items-center justify-center text-white font-bold text-lg mr-3">
            ${user.username.charAt(0).toUpperCase()}
          </div>
          <div>
            <div class="font-medium">${user.username}</div>
            <div class="text-xs text-gray-400 flex items-center">
              ${user.status || 'offline'}
              <span class="status-indicator ${user.status === 'online' ? 'online' : 'offline'}"></span>
            </div>
          </div>
        `;
        
        userElement.addEventListener('click', () => selectUser(user));
        userList.appendChild(userElement);
      });
    }
    
    // Filter users based on search term
    function filterUsers(searchTerm) {
      if (!searchTerm) {
        renderUsers(allUsers);
        return;
      }
      
      const filteredUsers = allUsers.filter(user => 
        user.username && user.username.toLowerCase().includes(searchTerm.toLowerCase())
      );
      
      renderUsers(filteredUsers);
    }
    
    // Select a user to chat with
    function selectUser(user) {
      selectedUser = user;
      
      // Highlight selected user
      document.querySelectorAll('.user-card').forEach(el => {
        el.classList.remove('active-user');
      });
      event.currentTarget.classList.add('active-user');
      
      // Update chat header
      chatHeader.innerHTML = `
        <div class="w-10 h-10 rounded-full bg-gradient-to-r from-amber-500 to-orange-500 flex items-center justify-center text-white font-bold text-lg mr-3">
          ${user.username.charAt(0).toUpperCase()}
        </div>
        <div>
          <div class="font-semibold">${user.username}</div>
          <div id="typingIndicator" class="text-xs text-gray-400 hidden">
            <div class="typing-indicator">
              <span>typing</span>
              <div class="typing-dot"></div>
              <div class="typing-dot"></div>
              <div class="typing-dot"></div>
            </div>
          </div>
        </div>
      `;
      
      // Enable message input
      messageInput.disabled = false;
      messageInput.placeholder = "Type a message...";
      sendBtn.disabled = false;
      sendBtn.className = "bg-gradient-to-r from-indigo-500 to-purple-600 text-white py-3 px-6 rounded-r-lg font-medium";
      
      // Load messages
      loadMessages();
      
      // Start polling for new messages
      startMessagePolling();
    }
    
    // Load messages between current user and selected user
    async function loadMessages() {
      try {
        messagesContainer.innerHTML = '';
        
        if (!selectedUser) return;
        
        const { data: messages, error } = await supabase
          .from('messages')
          .select('*')
          .or(`and(sender_id.eq.${currentUser.id},receiver_id.eq.${selectedUser.id}),and(sender_id.eq.${selectedUser.id},receiver_id.eq.${currentUser.id})`)
          .order('created_at', { ascending: true });
          
        if (error) {
          throw error;
        }
        
        if (!messages || messages.length === 0) {
          messagesContainer.innerHTML = `
            <div class="text-center text-gray-500 text-sm py-8">
              <i class="fas fa-comment-slash text-3xl mb-4"></i>
              <p>No messages yet. Start the conversation!</p>
            </div>
          `;
          return;
        }
        
        messages.forEach(message => {
          addMessageToUI(message);
        });
        
        // Scroll to bottom
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      } catch (error) {
        console.error('Message load error:', error);
        messagesContainer.innerHTML = `
          <div class="text-center text-red-400 text-sm py-8">
            <i class="fas fa-exclamation-triangle text-3xl mb-4"></i>
            <p>Error loading messages</p>
            <p class="text-xs mt-1">${error.message}</p>
          </div>
        `;
      }
    }
    
    // Add message to UI
    function addMessageToUI(message) {
      const isCurrentUser = message.sender_id === currentUser.id;
      const messageElement = document.createElement('div');
      
      messageElement.className = `message-bubble ${isCurrentUser ? 'sent' : 'received'}`;
      messageElement.innerHTML = `
        <div class="message-text">${message.content}</div>
        <div class="message-time text-xs opacity-70 mt-1 text-right">${formatTime(message.created_at)}</div>
      `;
      
      messagesContainer.appendChild(messageElement);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
    
    // Format time for display
    function formatTime(dateString) {
      try {
        const date = new Date(dateString);
        return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      } catch {
        return 'Now';
      }
    }
    
    // Start polling for new messages
    function startMessagePolling() {
      if (messagePolling) clearInterval(messagePolling);
      messagePolling = setInterval(() => selectedUser && loadMessages(), 3000);
    }
    
    // Send message
    async function sendMessage() {
      try {
        const content = messageInput.value.trim();
        if (!content || !selectedUser) return;
        
        const { error } = await supabase
          .from('messages')
          .insert({
            sender_id: currentUser.id,
            receiver_id: selectedUser.id,
            content: content
          });
          
        if (error) {
          throw error;
        }
        
        // Clear input and add to UI
        messageInput.value = '';
        const tempMessage = {
          sender_id: currentUser.id,
          content: content,
          created_at: new Date().toISOString()
        };
        addMessageToUI(tempMessage);
      } catch (error) {
        console.error('Message send error:', error);
        alert(`Failed to send message: ${error.message}`);
      }
    }
    
    // Update user status
    async function updateUserStatus(isOnline) {
      try {
        const status = isOnline ? 'online' : 'offline';
        userStatus.textContent = status;
        
        await supabase
          .from('profiles')
          .update({ status: status })
          .eq('id', currentUser.id);
      } catch (error) {
        console.error('Status update error:', error);
      }
    }
    
    // Set up event listeners
    function setupEventListeners() {
      // Send message
      sendBtn.addEventListener('click', sendMessage);
      messageInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });
      
      // Logout button
      logoutBtn.addEventListener('click', async () => {
        try {
          await supabase.auth.signOut();
          window.location.href = 'index.html';
        } catch (error) {
          console.error('Logout error:', error);
        }
      });
      
      // Status updates
      window.addEventListener('focus', () => updateUserStatus(true));
      window.addEventListener('blur', () => updateUserStatus(false));
      window.addEventListener('beforeunload', () => {
        updateUserStatus(false);
        if (messagePolling) clearInterval(messagePolling);
      });
      
      // Search functionality
      userSearch.addEventListener('input', (e) => {
        filterUsers(e.target.value.trim());
      });
    }
    
    // Initialize the app
    document.addEventListener('DOMContentLoaded', initApp);
  </script>
</body>
</html>
