<!DOCTYPE html><html lang="en" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cosmic Chat â€¢ Home</title>
  <!-- TailwindCSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            cosmicStart: '#0f114f',
            cosmicEnd: '#44107a',
            neon: '#35c5ff',
            galaxy: '#845ec2'
          },
          animation: {
            rotate: 'spin 8s linear infinite',
          }
        }
      }
    }
  </script>
  <!-- Supabase SDK v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      background: radial-gradient(at top left, rgba(255,255,255,.05) 0%, transparent 60%),
                  radial-gradient(at 80% 120%, rgba(255,255,255,.08) 0%, transparent 60%),
                  linear-gradient(120deg, var(--tw-color-cosmicStart), var(--tw-color-cosmicEnd));
    }
    .star-bg {
      background-image:
        url("data:image/svg+xml,%3Csvg width='100' height='100' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%23ffffff' fill-opacity='0.15'%3E%3Ccircle cx='1' cy='1' r='1'/%3E%3Ccircle cx='30' cy='50' r='1'/%3E%3Ccircle cx='70' cy='30' r='1'/%3E%3Ccircle cx='90' cy='90' r='1'/%3E%3C/g%3E%3C/svg%3E");
      background-repeat: repeat;
    }
  </style>
</head>
<body class="min-h-screen text-white flex flex-col star-bg relative">
  <!-- Dark / Light toggle -->
  <button id="themeToggle" class="fixed top-4 right-4 p-3 rounded-full bg-white/10 backdrop-blur hover:bg-white/20 transition duration-300">
    <span id="themeIcon" class="material-symbols-outlined">dark_mode</span>
  </button>  <!-- Floating AI Chat Button -->  <a href="https://takadori-galaxy.vercel.app/aichat.html" target="_blank" class="fixed bottom-6 right-6 bg-neon text-black font-semibold px-6 py-3 rounded-full shadow-lg hover:scale-105 transition transform duration-300 animate-bounce">
    Chat with AI ðŸ¤–
  </a>  <!-- Header -->  <header class="w-full py-4 px-6 flex justify-between items-center backdrop-blur bg-white/5 shadow-lg">
    <h1 class="text-2xl font-bold tracking-wide">ðŸš€ Cosmic Chat</h1>
    <div class="flex items-center gap-3">
      <span id="welcomeUser" class="text-sm opacity-80"></span>
      <button id="logoutBtn" class="px-3 py-1 bg-red-600 hover:bg-red-700 rounded text-sm">Logout</button>
    </div>
  </header>  <!-- Main Layout -->  <main class="flex-1 flex overflow-hidden">
    <!-- Sidebar -->
    <aside id="sidebar" class="w-64 max-md:w-48 bg-white/5 backdrop-blur flex-shrink-0 overflow-y-auto">
      <h2 class="px-4 py-3 text-lg font-semibold">Online Users</h2>
      <ul id="userList" class="space-y-1 px-2 pb-4"></ul>
    </aside><!-- Chat Area -->
<section class="flex-1 flex flex-col">
  <!-- Chat header -->
  <div id="chatHeader" class="h-16 flex items-center px-6 backdrop-blur bg-white/5 border-b border-white/10"></div>
  <!-- Messages -->
  <div id="messages" class="flex-1 overflow-y-auto px-4 py-6 space-y-4"></div>
  <!-- Input -->
  <form id="messageForm" class="flex items-center gap-2 p-4 backdrop-blur bg-white/5">
    <input id="messageInput" type="text" placeholder="Type a messageâ€¦" class="flex-1 bg-black/20 focus:bg-black/30 outline-none px-4 py-2 rounded" autocomplete="off" />
    <button class="px-4 py-2 bg-neon text-black rounded font-semibold">Send</button>
  </form>
</section>

  </main>  <!-- Username / Rank / Status Modal -->  <div id="profileModal" class="fixed inset-0 bg-black/70 flex items-center justify-center hidden">
    <div class="w-11/12 max-w-md bg-white text-black rounded-lg p-6 space-y-4">
      <h3 class="text-xl font-bold text-center">Set up your profile âœ¨</h3>
      <label class="block">
        <span class="block mb-1 font-medium">Username</span>
        <input id="usernameField" type="text" class="w-full border px-3 py-2 rounded" placeholder="Unique username" />
      </label>
      <label class="block">
        <span class="block mb-1 font-medium">Status</span>
        <select id="statusField" class="w-full border px-3 py-2 rounded">
          <option value="online">Online</option>
          <option value="busy">Busy</option>
          <option value="away">Away</option>
        </select>
      </label>
      <label class="block">
        <span class="block mb-1 font-medium">Rank</span>
        <select id="rankField" class="w-full border px-3 py-2 rounded">
          <option value="rookie">Rookie</option>
          <option value="elite">Elite</option>
          <option value="legend">Legend</option>
        </select>
      </label>
      <button id="saveProfileBtn" class="w-full bg-black text-white py-2 rounded font-semibold hover:bg-gray-800">Save & Continue</button>
      <p id="profileError" class="text-sm text-red-600"></p>
    </div>
  </div>  <!-- Premium Modal -->  <div id="premiumModal" class="fixed inset-0 bg-black/70 flex items-center justify-center hidden">
    <div class="max-w-sm bg-white text-black rounded-lg p-6 space-y-4 text-center">
      <h3 class="text-xl font-bold">Premium Required ðŸš€</h3>
      <p>Upgrade to premium to chat with others.</p>
      <button id="closePremium" class="w-full bg-black text-white py-2 rounded">Close</button>
    </div>
  </div>  <!-- Toast Container -->  <div id="toastContainer" class="fixed bottom-4 left-1/2 -translate-x-1/2 space-y-2 z-50"></div>  <script>
    // Supabase config
    const SUPABASE_URL = 'https://vmronlbzksuiikspvlvz.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZtcm9ubGJ6a3N1aWlrc3B2bHZ6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk5ODMwNTcsImV4cCI6MjA2NTU1OTA1N30.WMKbpJn1aavkwQDmsYq_-4EMSLL9tc4LexpmRSCsmSM';
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // DOM refs
    const welcomeEl = document.getElementById('welcomeUser');
    const logoutBtn = document.getElementById('logoutBtn');
    const sidebar = document.getElementById('sidebar');
    const userList = document.getElementById('userList');
    const messagesEl = document.getElementById('messages');
    const messageForm = document.getElementById('messageForm');
    const messageInput = document.getElementById('messageInput');
    const chatHeader = document.getElementById('chatHeader');
    const themeToggle = document.getElementById('themeToggle');
    const themeIcon = document.getElementById('themeIcon');

    // Modals
    const profileModal = document.getElementById('profileModal');
    const usernameField = document.getElementById('usernameField');
    const statusField = document.getElementById('statusField');
    const rankField = document.getElementById('rankField');
    const saveProfileBtn = document.getElementById('saveProfileBtn');
    const profileError = document.getElementById('profileError');

    const premiumModal = document.getElementById('premiumModal');
    const closePremium = document.getElementById('closePremium');

    // Toast container
    const toastContainer = document.getElementById('toastContainer');

    // State
    let currentUser = null;
    let currentProfile = null;
    let currentChat = null; // user id of active chat

    // === Theme Toggle ===
    const storedTheme = localStorage.getItem('theme');
    if (storedTheme === 'dark') document.documentElement.classList.add('dark');
    themeIcon.textContent = document.documentElement.classList.contains('dark') ? 'light_mode' : 'dark_mode';
    themeToggle.addEventListener('click', () => {
      document.documentElement.classList.toggle('dark');
      const isDark = document.documentElement.classList.contains('dark');
      themeIcon.textContent = isDark ? 'light_mode' : 'dark_mode';
      localStorage.setItem('theme', isDark ? 'dark' : 'light');
    });

    // === Toast util ===
    function showToast(msg) {
      const div = document.createElement('div');
      div.textContent = msg;
      div.className = 'bg-neon text-black px-4 py-2 rounded shadow-lg animate-pulse';
      toastContainer.appendChild(div);
      setTimeout(() => div.remove(), 4000);
    }

    // === Auth & Profile ===
    async function init() {
      const { data: { session }} = await supabase.auth.getSession();
      if (!session) {
        window.location.href = 'login.html';
        return;
      }
      currentUser = session.user;
      logoutBtn.addEventListener('click', async () => {
        await supabase.auth.signOut();
        window.location.href = 'login.html';
      });

      await loadProfile();
      subscribeProfileChanges();
      loadOnlineUsers();
      subscribeOnlineUsers();
    }

    async function loadProfile() {
      const { data, error } = await supabase.from('profiles').select('*').eq('id', currentUser.id).single();
      if (error && error.code !== 'PGRST116') console.error(error);
      if (!data || !data.username) {
        profileModal.classList.remove('hidden');
      } else {
        currentProfile = data;
        welcomeEl.innerHTML = `<span class="font-semibold">${data.username}</span> â€¢ <span class="text-xs opacity-70">${data.rank || 'rookie'}</span>`;
      }
    }

    saveProfileBtn.addEventListener('click', async () => {
      const username = usernameField.value.trim();
      const status = statusField.value;
      const rank = rankField.value;
      if (!username) {
        profileError.textContent = 'Username required';
        return;
      }
      const { data: dup } = await supabase.from('profiles').select('id').eq('username', username);
      if (dup.length > 0) {
        profileError.textContent = 'Username already taken';
        return;
      }
      const { error } = await supabase.from('profiles').upsert({
        id: currentUser.id,
        username,
        status,
        rank,
        premium: false // default
      });
      if (error) {
        profileError.textContent = error.message;
        return;
      }
      profileModal.classList.add('hidden');
      await loadProfile();
    });

    // === Online Users ===
    async function loadOnlineUsers() {
      const { data, error } = await supabase.from('profiles').select('*').eq('status', 'online');
      if (error) return console.error(error);
      renderUserList(data);
    }

    function renderUserList(users) {
      userList.innerHTML = '';
      users.filter(u => u.id !== currentUser.id).forEach(u => {
        const li = document.createElement('li');
        li.className = 'flex items-center gap-2 p-2 rounded hover:bg-white/10 cursor-pointer';
        li.innerHTML = `<div class="w-3 h-3 bg-green-400 rounded-full"></div><span>${u.username}</span> ${u.premium ? '<span class="ml-auto text-xs bg-yellow-400 text-black px-1 rounded">â˜…</span>' : ''}`;
        li.addEventListener('click', () => handleUserSelect(u));
        userList.appendChild(li);
      });
    }

    function subscribeOnlineUsers() {
      supabase.channel('online-users')
        .on('postgres_changes', { event: '*', schema: 'public', table: 'profiles' }, payload => {
          if (payload.eventType === 'UPDATE' && payload.new.status === 'online') {
            showToast(`${payload.new.username} is online`);
          }
          loadOnlineUsers();
        })
        .subscribe();
    }

    // === Messaging ===
    async function handleUserSelect(user) {
      // premium logic
      if (!currentProfile.premium) {
        premiumModal.classList.remove('hidden');
        return;
      }
      currentChat = user;
      chatHeader.innerHTML = `<h3 class="font-semibold">${user.username}</h3>`;
      loadMessages();
    }

    async function loadMessages() {
      if (!currentChat) return;
      const { data, error } = await supabase.from('messages').select('*').or(`and(sender.eq.${currentUser.id},receiver.eq.${currentChat.id}),and(sender.eq.${currentChat.id},receiver.eq.${currentUser.id})`).order('created_at', { ascending: true });
      if (error) return console.error(error);
      renderMessages(data);
      subscribeMessages();
    }

    function renderMessages(list) {
      messagesEl.innerHTML = '';
      list.forEach(msg => {
        const div = document.createElement('div');
        const isMe = msg.sender === currentUser.id;
        div.className = `max-w-[75%] px-4 py-2 rounded-lg ${isMe ? 'bg-neon text-black ml-auto' : 'bg-white/10'} shadow`;
        div.innerText = msg.content;
        messagesEl.appendChild(div);
      });
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function subscribeMessages() {
      supabase.channel('direct-messages')
        .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, payload => {
          const msg = payload.new;
          if ((msg.sender === currentChat.id && msg.receiver === currentUser.id) || (msg.sender === currentUser.id && msg.receiver === currentChat.id)) {
            renderMessages([msg]);
            if (msg.sender !== currentUser.id) showToast(`New message from ${currentChat.username}`);
          }
        })
        .subscribe();
    }

    messageForm.addEventListener('submit', async e => {
      e.preventDefault();
      const content = messageInput.value.trim();
      if (!content || !currentChat) return;
      const { error } = await supabase.from('messages').insert({ sender: currentUser.id, receiver: currentChat.id, content });
      if (!error) messageInput.value = '';
    });

    // === Premium Modal ===
    closePremium.addEventListener('click', () => premiumModal.classList.add('hidden'));

    // === Realtime profile updates ===
    function subscribeProfileChanges() {
      supabase.channel('my-profile')
        .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'profiles', filter: `id=eq.${currentUser.id}` }, payload => {
          currentProfile = payload.new;
        })
        .subscribe();
    }

    // Start app
    init();
  </script>  <!-- Icons (Google Material Symbols) -->  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
</body>
</html>
