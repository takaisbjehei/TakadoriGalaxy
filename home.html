<!DOCTYPE html><html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TakaGalaxy</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: 'Inter', sans-serif; background: #0f172a; color: #f1f5f9; margin: 0; padding: 0; height: 100vh; overflow: hidden; }
    .chat-container { display: flex; flex-direction: column; height: 100vh; }
    .header, .footer { background: #1e293b; padding: 1rem; }
    .messages { flex: 1; overflow-y: auto; padding: 1rem; display: flex; flex-direction: column; gap: 0.75rem; }
    .message { max-width: 70%; padding: 0.75rem 1rem; border-radius: 1rem; position: relative; }
    .sent { align-self: flex-end; background: linear-gradient(to right, #6366f1, #8b5cf6); color: white; border-bottom-right-radius: 0.25rem; }
    .received { align-self: flex-start; background-color: #334155; border-bottom-left-radius: 0.25rem; }
    .typing-indicator { font-size: 0.8rem; color: #94a3b8; padding: 0 1rem; margin-bottom: 0.5rem; display: none; }
    .modal { position: fixed; inset: 0; display: flex; justify-content: center; align-items: center; background-color: rgba(0,0,0,0.8); z-index: 100; }
    .modal-content { background-color: #1e293b; padding: 2rem; border-radius: 1rem; max-width: 400px; width: 90%; }
    .modal-content input { width: 100%; padding: 0.75rem; background: #334155; color: white; border-radius: 0.5rem; border: none; margin-top: 1rem; }
    .modal-content button { margin-top: 1rem; width: 100%; padding: 0.75rem; background: #6366f1; color: white; border-radius: 0.5rem; border: none; }
  </style>
</head>
<body>
  <!-- Username setup modal -->
  <div id="usernameModal" class="modal hidden">
    <div class="modal-content">
      <h2 class="text-xl font-bold text-white">Set Your Username</h2>
      <input type="text" id="usernameInput" placeholder="Enter a unique username" />
      <p id="usernameError" class="text-red-400 text-sm hidden mt-1">Invalid or taken username</p>
      <button onclick="setUsername()">Save Username</button>
    </div>
  </div>  <div class="chat-container">
    <div class="header flex justify-between">
      <h1 class="text-lg font-bold">TakaGalaxy</h1>
      <button id="logoutBtn" class="text-sm text-gray-300 hover:text-white">Logout</button>
    </div>
    <div id="typingBubble" class="typing-indicator">Typing...</div>
    <div id="messagesContainer" class="messages">
      <div id="chatFallback" class="text-center text-gray-500">No chats yet. Add a user to begin.</div>
    </div>
    <div class="footer flex gap-2">
      <input id="messageInput" class="flex-1 bg-gray-800 text-white px-4 py-2 rounded-l-md focus:outline-none" placeholder="Type a message..." disabled />
      <button id="sendBtn" class="bg-indigo-500 hover:bg-indigo-600 text-white px-4 py-2 rounded-r-md" disabled>Send</button>
    </div>
  </div>  <script>
    // Initialize Supabase client
    const supabaseUrl = 'https://vmronlbzksuiikspvlvz.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZtcm9ubGJ6a3N1aWlrc3B2bHZ6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk5ODMwNTcsImV4cCI6MjA2NTU1OTA1N30.WMKbpJn1aavkwQDmsYq_-4EMSLL9tc4LexpmRSCsmSM';
    const supabase = supabase.createClient(supabaseUrl, supabaseKey);

    // Elements
    const usernameModal = document.getElementById('usernameModal');
    const usernameInput = document.getElementById('usernameInput');
    const usernameError = document.getElementById('usernameError');
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    const messagesContainer = document.getElementById('messagesContainer');
    const chatFallback = document.getElementById('chatFallback');
    const logoutBtn = document.getElementById('logoutBtn');
    const typingBubble = document.getElementById('typingBubble');

    let currentUser = null;
    let selectedUser = null;

    // Redirect on auth changes
    supabase.auth.onAuthStateChange((event, session) => {
      if (!session) window.location.href = 'index.html';
    });

    async function init() {
      // Check logged in user
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) return window.location.href = 'index.html';
      currentUser = user;

      // Ensure profile row exists
      let { data: profile } = await supabase.from('profiles').select('username').eq('id', user.id).single();
      if (!profile) {
        await supabase.from('profiles').insert({ id: user.id, email: user.email });
        profile = { username: null };
      }

      // If no username, show modal and block chat
      if (!profile.username) {
        usernameModal.classList.remove('hidden');
        return;
      }

      // Username set: enable chat
      usernameModal.classList.add('hidden');
      messageInput.disabled = false;
      sendBtn.disabled = false;

      // Load a friend and messages
      selectedUser = await fetchAnyFriend();
      if (!selectedUser) {
        chatFallback.innerText = 'No friends found. Add one first.';
        return;
      } else {
        chatFallback.classList.add('hidden');
        loadMessages();
        subscribeToRealtime();
      }
    }

    async function setUsername() {
      const username = usernameInput.value.trim();
      if (username.length < 3 || username.length > 20) {
        usernameError.textContent = 'Username must be 3-20 characters';
        usernameError.classList.remove('hidden');
        return;
      }
      const { data: existing } = await supabase.from('profiles').select('id').eq('username', username);
      if (existing.length) {
        usernameError.textContent = 'Username taken';
        usernameError.classList.remove('hidden');
        return;
      }
      await supabase.from('profiles').update({ username }).eq('id', currentUser.id);
      window.location.reload();
    }

    logoutBtn.onclick = async () => {
      await supabase.auth.signOut();
    };

    async function fetchAnyFriend() {
      const { data: conns } = await supabase.from('connections').select('friend_id').eq('user_id', currentUser.id).limit(1);
      if (!conns.length) return null;
      const { data: friend } = await supabase.from('profiles').select('id,username').eq('id', conns[0].friend_id).single();
      return friend;
    }

    async function loadMessages() {
      if (!selectedUser) return;
      const { data } = await supabase.from('messages')
        .select('*')
        .or(`and(sender_id.eq.${currentUser.id},receiver_id.eq.${selectedUser.id}),and(sender_id.eq.${selectedUser.id},receiver_id.eq.${currentUser.id})`)
        .order('created_at', { ascending: true });
      messagesContainer.innerHTML = '';
      data.forEach(addMessageToUI);
    }

    function addMessageToUI(msg) {
      const div = document.createElement('div');
      div.className = `message ${msg.sender_id === currentUser.id ? 'sent' : 'received'}`;
      div.innerHTML = `<div>${msg.content}</div>`;
      messagesContainer.appendChild(div);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    sendBtn.onclick = async () => {
      if (!messageInput.value.trim() || !selectedUser) return;
      await supabase.from('messages').insert({ sender_id: currentUser.id, receiver_id: selectedUser.id, content: messageInput.value.trim() });
      messageInput.value = '';
    };

    function subscribeToRealtime() {
      supabase.channel('public:messages')
        .on('postgres_changes', { event: 'INSERT', table: 'messages' }, payload => {
          const m = payload.new;
          if ((m.sender_id === currentUser.id && m.receiver_id === selectedUser.id) || (m.sender_id === selectedUser.id && m.receiver_id === currentUser.id)) {
            addMessageToUI(m);
          }
        })
        .subscribe();

      supabase.channel('public:typing_status')
        .on('postgres_changes', { event: 'UPDATE', table: 'typing_status' }, payload => {
          const t = payload.new;
          if (t.sender_id === selectedUser?.id && t.receiver_id === currentUser.id) {
            typingBubble.style.display = t.is_typing ? 'block' : 'none';
          }
        })
        .subscribe();
    }

    document.addEventListener('DOMContentLoaded', init);
  </script></body>
</html>
