<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Adaptive AI Chatbox</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* --- Theme Variables --- */
        :root {
            --theme-bg-gradient: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
            --theme-text-primary: #e0e0e0;
            --theme-text-secondary: #b0b0b0;
            --theme-panel-bg: rgba(255, 255, 255, 0.08);
            --theme-border-color: rgba(255, 255, 255, 0.1);
            --theme-hover-bg: rgba(255, 255, 255, 0.15);
            --theme-input-bg: rgba(0, 0, 0, 0.2);
            --theme-accent-gradient: linear-gradient(135deg, #00b4db, #0083b0);
            --theme-accent-text: #ffffff;
            --theme-user-msg-bg: linear-gradient(135deg, #0093E9, #80D0C7);
            --theme-user-msg-text: #ffffff;
            --theme-bot-msg-bg: rgba(255, 255, 255, 0.1);
            --theme-bot-msg-text: #e0e0e0;
            --theme-scrollbar-thumb: #00b4db;
            --theme-icon-color: #00b4db;
        }

        body.theme-light {
            --theme-bg-gradient: linear-gradient(135deg, #e9e9e9, #f5f5f5);
            --theme-text-primary: #2c3e50;
            --theme-text-secondary: #555;
            --theme-panel-bg: rgba(255, 255, 255, 0.8);
            --theme-border-color: #dcdcdc;
            --theme-hover-bg: #e0e0e0;
            --theme-input-bg: #ffffff;
            --theme-accent-gradient: linear-gradient(135deg, #1e88e5, #007acc);
            --theme-accent-text: #ffffff;
            --theme-user-msg-bg: linear-gradient(135deg, #1e88e5, #007acc);
            --theme-user-msg-text: #ffffff;
            --theme-bot-msg-bg: #e8eaf6;
            --theme-bot-msg-text: #2c3e50;
            --theme-scrollbar-thumb: #1e88e5;
            --theme-icon-color: #1e88e5;
        }
        
        body.theme-synthwave {
            --theme-bg-gradient: linear-gradient(135deg, #2c1a4d, #1f1437);
            --theme-text-primary: #00e0ff;
            --theme-text-secondary: #ff00ff;
            --theme-panel-bg: rgba(10, 5, 20, 0.7);
            --theme-border-color: rgba(255, 0, 255, 0.5);
            --theme-hover-bg: rgba(255, 0, 255, 0.1);
            --theme-input-bg: rgba(10, 5, 20, 0.9);
            --theme-accent-gradient: linear-gradient(135deg, #ff00ff, #00e0ff);
            --theme-accent-text: #1f1437;
            --theme-user-msg-bg: linear-gradient(135deg, #ff00ff, #f83dff);
            --theme-user-msg-text: #ffffff;
            --theme-bot-msg-bg: rgba(0, 224, 255, 0.1);
            --theme-bot-msg-text: #00e0ff;
            --theme-scrollbar-thumb: #ff00ff;
            --theme-icon-color: #00e0ff;
        }

        /* --- Base Styles --- */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            scrollbar-width: thin;
            scrollbar-color: var(--theme-scrollbar-thumb) transparent;
        }
        
        body {
            background: var(--theme-bg-gradient);
            color: var(--theme-text-primary);
            height: 100vh;
            display: flex;
            overflow: hidden;
            transition: background 0.5s ease;
        }
        
        /* --- Sidebar & History --- */
        .sidebar {
            width: 260px;
            background-color: var(--theme-panel-bg);
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--theme-border-color);
            height: 100vh;
            transition: transform 0.3s ease-in-out, background-color 0.5s, border-color 0.5s;
            flex-shrink: 0;
        }
        
        .logo {
            padding: 20px;
            border-bottom: 1px solid var(--theme-border-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .logo h1 { font-size: 1.5rem; background: var(--theme-accent-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .logo i { font-size: 1.8rem; color: var(--theme-icon-color); }
        
        .new-chat-btn { margin: 15px; padding: 12px; border: 1px solid var(--theme-border-color); border-radius: 8px; background: transparent; color: var(--theme-text-primary); cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .new-chat-btn:hover { background: var(--theme-hover-bg); }
        .chat-history { flex: 1; overflow-y: auto; padding: 10px; }
        .chat-item { padding: 12px; border-radius: 8px; margin-bottom: 8px; cursor: pointer; transition: background 0.3s; display: flex; align-items: center; gap: 8px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .chat-item:hover { background: var(--theme-hover-bg); }
        .chat-item.active { background: var(--theme-hover-bg); }

        /* --- Theme Switcher --- */
        .theme-switcher { padding: 10px 15px; border-top: 1px solid var(--theme-border-color); }
        .theme-switcher h3 { font-size: 0.9rem; margin-bottom: 10px; font-weight: 500; }
        .theme-buttons { display: flex; justify-content: space-around; }
        .theme-btn { width: 30px; height: 30px; border-radius: 50%; border: 2px solid var(--theme-border-color); cursor: pointer; transition: transform 0.2s; }
        .theme-btn:hover, .theme-btn.active { transform: scale(1.15); border-width: 3px; }
        #dark-theme { background: #2c5364; }
        #light-theme { background: #f5f5f5; }
        #synth-theme { background: #2c1a4d; border-color: #ff00ff;}

        /* --- Main Content --- */
        .main-content { flex: 1; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        .chat-header { padding: 15px 20px; border-bottom: 1px solid var(--theme-border-color); display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        .menu-toggle { display: none; background: none; border: none; color: var(--theme-text-primary); font-size: 1.2rem; cursor: pointer; padding: 8px; }
        .chat-title { font-size: 1.2rem; font-weight: 500; }
        .header-btn { padding: 8px 12px; border: none; border-radius: 6px; background: var(--theme-panel-bg); color: var(--theme-text-primary); cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; gap: 5px; font-size: 0.9rem; }
        .header-btn:hover { background: var(--theme-hover-bg); }
        .chatbox { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 20px; }
        .message { max-width: 85%; padding: 12px 18px; border-radius: 18px; line-height: 1.5; animation: fadeIn 0.3s ease; word-wrap: break-word; }
        .user-message { align-self: flex-end; background: var(--theme-user-msg-bg); color: var(--theme-user-msg-text); border-bottom-right-radius: 5px; }
        .bot-message { align-self: flex-start; background: var(--theme-bot-msg-bg); border: 1px solid var(--theme-border-color); color: var(--theme-bot-msg-text); border-bottom-left-radius: 5px; }
        .input-area { padding: 15px; background: var(--theme-input-bg); border-top: 1px solid var(--theme-border-color); flex-shrink: 0; }
        .input-container { display: flex; max-width: 800px; margin: 0 auto; background: var(--theme-panel-bg); border-radius: 24px; padding: 5px; border: 1px solid var(--theme-border-color); }
        input { flex: 1; padding: 12px 16px; border: none; background: transparent; color: var(--theme-text-primary); font-size: 1rem; outline: none; }
        input::placeholder { color: var(--theme-text-secondary); }
        .send-btn { padding: 10px 18px; border: none; border-radius: 24px; background: var(--theme-accent-gradient); color: var(--theme-accent-text); font-weight: bold; cursor: pointer; transition: transform 0.2s ease, background 0.3s; display: flex; align-items: center; gap: 5px; }
        .send-btn:hover { transform: scale(1.05); }
        .send-btn:disabled { background: var(--theme-hover-bg); cursor: not-allowed; transform: none; }
        .typing-indicator { display: none; align-self: flex-start; background: var(--theme-bot-msg-bg); border: 1px solid var(--theme-border-color); border-radius: 18px; padding: 16px 20px; margin-bottom: 10px; border-bottom-left-radius: 5px; }
        .typing-indicator span { height: 8px; width: 8px; background: var(--theme-text-secondary); display: inline-block; border-radius: 50%; margin-right: 5px; animation: typing 1.3s infinite; }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }

        /* --- Memory Panel --- */
        .memory-panel { position: fixed; right: 0; top: 0; width: 320px; height: 100vh; background-color: rgba(20, 20, 30, 0.95); backdrop-filter: blur(10px); border-left: 1px solid var(--theme-border-color); padding: 20px; transition: transform 0.3s ease-in-out; transform: translateX(100%); overflow-y: auto; z-index: 1000; }
        .memory-panel.open { transform: translateX(0); }
        .memory-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .close-memory { background: none; border: none; color: var(--theme-text-primary); font-size: 1.2rem; cursor: pointer; }
        .memory-section { margin-bottom: 20px; }
        .memory-section h3 { margin-bottom: 10px; color: var(--theme-icon-color); }
        .memory-box { background: var(--theme-input-bg); border-radius: 8px; padding: 15px; font-size: 0.95rem; line-height: 1.5; max-height: 150px; overflow-y: auto; }
        .memory-edit { width: 100%; background: var(--theme-panel-bg); border: 1px solid var(--theme-border-color); border-radius: 8px; padding: 15px; color: var(--theme-text-primary); resize: vertical; min-height: 120px; font-family: inherit; margin-top: 10px; }
        .save-memory-btn { width: 100%; padding: 12px; border: none; border-radius: 8px; background: var(--theme-accent-gradient); color: var(--theme-accent-text); font-weight: bold; cursor: pointer; transition: transform 0.2s ease; margin-top: 20px; }
        .save-memory-btn:hover { transform: scale(1.02); }
        
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 998; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s; }
        .overlay.visible { opacity: 1; visibility: visible; }
        
        @media (max-width: 768px) {
            .sidebar { position: fixed; left: 0; top: 0; z-index: 1001; transform: translateX(-100%); }
            .sidebar.open { transform: translateX(0); box-shadow: 5px 0 15px rgba(0,0,0,0.2); }
            .menu-toggle { display: block; }
            .main-content { width: 100%; }
            .memory-panel { width: 90%; max-width: 320px; }
        }
        
        @keyframes typing { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="theme-dark">
    <div class="sidebar" id="sidebar">
        <div class="logo"> <i class="fas fa-brain"></i> <h1>Adaptive AI</h1> </div>
        <button class="new-chat-btn" id="new-chat-btn"> <i class="fas fa-plus"></i> New Chat </button>
        <div class="chat-history" id="chat-list"></div>
        <div class="theme-switcher">
            <h3>Theme</h3>
            <div class="theme-buttons">
                <button class="theme-btn active" id="dark-theme" data-theme="theme-dark" aria-label="Dark Theme"></button>
                <button class="theme-btn" id="light-theme" data-theme="theme-light" aria-label="Light Theme"></button>
                <button class="theme-btn" id="synth-theme" data-theme="theme-synthwave" aria-label="Synthwave Theme"></button>
            </div>
        </div>
    </div>
    
    <div class="main-content">
        <div class="chat-header">
            <button class="menu-toggle" id="menu-toggle" aria-label="Open menu"> <i class="fas fa-bars"></i> </button>
            <div class="chat-title" id="chat-title">New Chat</div>
            <div class="chat-controls"> <button class="header-btn" id="memory-btn"> <i class="fas fa-memory"></i> Profile & Memory </button> </div>
        </div>
        <div class="chatbox" id="chatbox">
            <div class="message bot-message"> Hello! I'm your adaptive AI. I'll learn from our conversations to better assist you. How can I help you today? </div>
            <div class="typing-indicator" id="typing-indicator"> <span></span><span></span><span></span> </div>
        </div>
        <div class="input-area">
            <div class="input-container">
                <input type="text" id="user-input" placeholder="Type your message here..." autocomplete="off">
                <button class="send-btn" id="send-btn" aria-label="Send message"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    </div>
    
    <div class="memory-panel" id="memory-panel">
        <div class="memory-header"> <h2>AI Memory</h2> <button class="close-memory" id="close-memory"><i class="fas fa-times"></i></button> </div>
        <div class="memory-section"> <h3>User Profile Summary</h3> <div class="memory-box" id="profile-summary-display"></div> <textarea class="memory-edit" id="profile-summary-edit" placeholder="Manually edit the user profile summary..."></textarea> </div>
        <div class="memory-section"> <h3>Key Facts About User</h3> <div class="memory-box" id="key-facts-display"></div> <textarea class="memory-edit" id="key-facts-edit" placeholder="Manually edit key facts, one per line..."></textarea> </div>
        <div class="memory-section"> <h3>Short-Term Conversation Memory</h3> <div class="memory-box" id="conversation-memory-display"></div> <textarea class="memory-edit" id="conversation-memory-edit" placeholder="Edit short-term memory..."></textarea> </div>
        <button class="save-memory-btn" id="save-memory-btn">Update Memory & Profile</button>
    </div>
    <div class="overlay" id="overlay"></div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- DOM Elements ---
            const ui = {
                body: document.body,
                sidebar: document.getElementById('sidebar'),
                chatbox: document.getElementById('chatbox'),
                userInput: document.getElementById('user-input'),
                sendBtn: document.getElementById('send-btn'),
                typingIndicator: document.getElementById('typing-indicator'),
                newChatBtn: document.getElementById('new-chat-btn'),
                chatList: document.getElementById('chat-list'),
                chatTitle: document.getElementById('chat-title'),
                menuToggle: document.getElementById('menu-toggle'),
                overlay: document.getElementById('overlay'),
                // Memory Panel
                memoryBtn: document.getElementById('memory-btn'),
                memoryPanel: document.getElementById('memory-panel'),
                closeMemory: document.getElementById('close-memory'),
                profileSummaryDisplay: document.getElementById('profile-summary-display'),
                profileSummaryEdit: document.getElementById('profile-summary-edit'),
                keyFactsDisplay: document.getElementById('key-facts-display'),
                keyFactsEdit: document.getElementById('key-facts-edit'),
                conversationMemoryDisplay: document.getElementById('conversation-memory-display'),
                conversationMemoryEdit: document.getElementById('conversation-memory-edit'),
                saveMemoryBtn: document.getElementById('save-memory-btn'),
                // Theme switcher
                themeButtons: document.querySelectorAll('.theme-btn'),
            };
            
            // --- CONFIGURATION ---
            // PASTE YOUR GROQ API KEY HERE
            const API_KEY = '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'; 
            // CHOOSE YOUR MODELS
            const MAIN_MODEL = 'gemma2-9b-it'; // For chat responses
            const ANALYSIS_MODEL = 'llama3-8b-8192'; // For memory/profile updates

            // --- State Management ---
            let state = {
                chatHistory: [], currentChatId: null, isSidebarOpen: false,
                userProfile: { summary: "A new user.", keyFacts: [], style: "neutral" },
                conversationMemory: "The conversation has just begun."
            };

            // --- Initialization ---
            function init() {
                loadState();
                applySavedTheme();
                initEventListeners();
                ui.userInput.focus();
                loadChatHistoryList();
                updateMemoryPanelDisplay();
                startNewChat();
            }
            
            function loadState() {
                state.chatHistory = JSON.parse(localStorage.getItem('chatHistory')) || [];
                state.userProfile = JSON.parse(localStorage.getItem('userProfile')) || state.userProfile;
            }

            function saveState() {
                localStorage.setItem('chatHistory', JSON.stringify(state.chatHistory));
                localStorage.setItem('userProfile', JSON.stringify(state.userProfile));
            }
            
            // --- Event Listeners ---
            function initEventListeners() {
                ui.sendBtn.addEventListener('click', handleSend);
                ui.userInput.addEventListener('keypress', e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSend(); } });
                ui.newChatBtn.addEventListener('click', startNewChat);
                ui.saveMemoryBtn.addEventListener('click', saveMemoryFromPanel);
                ui.memoryBtn.addEventListener('click', () => ui.memoryPanel.classList.add('open'));
                ui.closeMemory.addEventListener('click', () => ui.memoryPanel.classList.remove('open'));
                ui.menuToggle.addEventListener('click', toggleSidebar);
                ui.overlay.addEventListener('click', () => { if (state.isSidebarOpen) toggleSidebar(); });
                window.addEventListener('popstate', handlePopState);
                ui.themeButtons.forEach(button => {
                    button.addEventListener('click', () => changeTheme(button.dataset.theme));
                });
            }
            
            // --- Core Chat Logic ---
            async function handleSend() {
                const message = ui.userInput.value.trim();
                if (!message) return;

                addMessageToUI(message, true);
                const currentUserMessage = message;
                ui.userInput.value = '';
                setSendingState(true);

                try {
                    const response = await getGroqResponse(currentUserMessage);
                    addMessageToUI(response);
                    updateChatHistory(currentUserMessage, response);
                    saveState();
                    loadChatHistoryList();
                    await adaptToUser(currentUserMessage, response);
                } catch (error) {
                    addMessageToUI("Sorry, an error occurred. Please check your API key and network connection.");
                    console.error("API Error:", error);
                } finally {
                    setSendingState(false);
                }
            }
            
            function addMessageToUI(text, isUser = false) {
                const messageDiv = document.createElement('div');
                messageDiv.classList.add('message', isUser ? 'user-message' : 'bot-message');
                messageDiv.textContent = text;
                ui.chatbox.insertBefore(messageDiv, ui.typingIndicator);
                ui.chatbox.scrollTop = ui.chatbox.scrollHeight;
            }

            function setSendingState(isSending) {
                ui.typingIndicator.style.display = isSending ? 'flex' : 'none';
                ui.sendBtn.disabled = isSending;
                ui.userInput.disabled = isSending;
                if (!isSending) ui.userInput.focus();
                if (isSending) ui.chatbox.scrollTop = ui.chatbox.scrollHeight;
            }

            // --- API & Memory Functions ---
            async function getGroqResponse(message) {
                if (!API_KEY || API_KEY === 'gsk_...') return "API Key not configured. Please add your Groq API key in the script.";
                
                const systemPrompt = `You are an adaptive AI assistant. User Profile: - Summary: ${state.userProfile.summary} - Key Facts: ${state.userProfile.keyFacts.join(", ")}. Their Style: ${state.userProfile.style}. Short-term memory: "${state.conversationMemory}". Adapt your personality, tone, and language to match the user. Be conversational and remember these details to provide a helpful and personalized response.`;

                const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${API_KEY}` },
                    body: JSON.stringify({
                        model: MAIN_MODEL, messages: [{ role: "system", content: systemPrompt }, { role: 'user', content: message }],
                        temperature: 0.7, max_tokens: 1024
                    })
                });
                if (!response.ok) throw new Error(`API error: ${response.status} ${await response.text()}`);
                const data = await response.json();
                return data.choices[0].message.content;
            }
            
            async function adaptToUser(userMessage, botResponse) {
                const metaPrompt = `Based on the following conversation excerpt and the existing user profile, update the user profile. Existing Profile: ${JSON.stringify(state.userProfile)} User said: "${userMessage}" You (AI) responded: "${botResponse}" Analyze the user's language (slang, tone, formality), stated facts, and emotional state. Also, create a concise summary of the last two turns of conversation for short-term memory. Return ONLY a valid JSON object with the updated profile and memory. The JSON object must have keys: 'summary', 'keyFacts' (as an array of strings), 'style' (e.g., 'casual', 'formal'), and 'conversationMemory'. Do not add any other text or explanations.`;
                try {
                    const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${API_KEY}` },
                        body: JSON.stringify({ model: ANALYSIS_MODEL, messages: [{ role: 'system', content: metaPrompt }], temperature: 0.5, max_tokens: 512, response_format: { type: "json_object" } })
                    });
                    if (!response.ok) throw new Error("Failed to get analysis from meta-prompt.");
                    const data = await response.json();
                    const analysis = JSON.parse(data.choices[0].message.content);
                    state.userProfile = { summary: analysis.summary || state.userProfile.summary, keyFacts: analysis.keyFacts || state.userProfile.keyFacts, style: analysis.style || state.userProfile.style };
                    state.conversationMemory = analysis.conversationMemory || state.conversationMemory;
                    saveState();
                    updateMemoryPanelDisplay();
                } catch (error) { console.error("Could not adapt to user:", error); }
            }

            // --- Chat History Management ---
            function updateChatHistory(userMsg, botMsg) {
                if (state.currentChatId === null) createNewChatSession(userMsg, botMsg);
                else {
                    const chat = state.chatHistory.find(c => c.id === state.currentChatId);
                    if (chat) { chat.messages.push({ text: userMsg, isUser: true }, { text: botMsg, isUser: false }); }
                }
            }

            function createNewChatSession(firstUserMsg, firstBotMsg) {
                const title = firstUserMsg.substring(0, 25) + (firstUserMsg.length > 25 ? "..." : "");
                const newChat = { id: Date.now().toString(), title: title, messages: [{ text: firstUserMsg, isUser: true }, { text: firstBotMsg, isUser: false }] };
                state.chatHistory.push(newChat);
                state.currentChatId = newChat.id;
                ui.chatTitle.textContent = title;
            }
            
            function loadChatHistoryList() {
                ui.chatList.innerHTML = '';
                if (state.chatHistory.length === 0) { ui.chatList.innerHTML = '<div class="chat-item">No saved chats</div>'; return; }
                state.chatHistory.forEach(chat => {
                    const chatItem = document.createElement('div');
                    chatItem.innerHTML = `<i class="far fa-comment-dots"></i> <span>${chat.title}</span>`;
                    chatItem.classList.add('chat-item');
                    if (chat.id === state.currentChatId) chatItem.classList.add('active');
                    chatItem.addEventListener('click', () => loadChat(chat.id));
                    ui.chatList.prepend(chatItem);
                });
            }

            function loadChat(chatId) {
                const chat = state.chatHistory.find(c => c.id === chatId);
                if (!chat) return;
                state.currentChatId = chatId;
                ui.chatTitle.textContent = chat.title;
                ui.chatbox.innerHTML = ''; 
                ui.chatbox.appendChild(ui.typingIndicator);
                chat.messages.forEach(msg => addMessageToUI(msg.text, msg.isUser));
                loadChatHistoryList(); // To update active state
                if (state.isSidebarOpen) toggleSidebar();
            }

            function startNewChat() {
                state.currentChatId = null;
                ui.chatTitle.textContent = "New Chat";
                ui.chatbox.innerHTML = '';
                ui.chatbox.appendChild(ui.typingIndicator);
                addMessageToUI("Hello! I'm your adaptive AI. How can I help you today?", false);
                state.conversationMemory = "The conversation has just begun.";
                updateMemoryPanelDisplay();
                loadChatHistoryList();
                if (state.isSidebarOpen) toggleSidebar();
                ui.userInput.focus();
            }

            // --- UI & Mobile Helpers ---
            function updateMemoryPanelDisplay() {
                ui.profileSummaryDisplay.textContent = state.userProfile.summary;
                ui.profileSummaryEdit.value = state.userProfile.summary;
                ui.keyFactsDisplay.innerHTML = state.userProfile.keyFacts.length ? `<ul>${state.userProfile.keyFacts.map(fact => `<li>${fact}</li>`).join('')}</ul>` : "No key facts saved yet.";
                ui.keyFactsEdit.value = state.userProfile.keyFacts.join('\n');
                ui.conversationMemoryDisplay.textContent = state.conversationMemory;
                ui.conversationMemoryEdit.value = state.conversationMemory;
            }

            function saveMemoryFromPanel() {
                state.userProfile.summary = ui.profileSummaryEdit.value;
                state.userProfile.keyFacts = ui.keyFactsEdit.value.split('\n').filter(fact => fact.trim() !== '');
                state.conversationMemory = ui.conversationMemoryEdit.value;
                saveState();
                updateMemoryPanelDisplay();
                // Optional: Add a notification
            }
            
            function toggleSidebar() {
                state.isSidebarOpen = !state.isSidebarOpen;
                ui.sidebar.classList.toggle('open', state.isSidebarOpen);
                ui.overlay.classList.toggle('visible', state.isSidebarOpen);
                // Manage browser history for back button functionality
                if (state.isSidebarOpen && window.innerWidth <= 768) {
                    history.pushState({ sidebarOpen: true }, "");
                } else if (!state.isSidebarOpen && window.innerWidth <= 768) {
                    if (history.state && history.state.sidebarOpen) {
                        history.back();
                    }
                }
            }

            function handlePopState(event) {
                // If the sidebar is open and we get a popstate, it means the user hit 'back'
                if (state.isSidebarOpen) {
                    state.isSidebarOpen = false;
                    ui.sidebar.classList.remove('open');
                    ui.overlay.classList.remove('visible');
                }
            }

            function changeTheme(themeName) {
                ui.body.className = themeName;
                localStorage.setItem('chatTheme', themeName);
                ui.themeButtons.forEach(button => {
                    button.classList.toggle('active', button.dataset.theme === themeName);
                });
            }

            function applySavedTheme() {
                const savedTheme = localStorage.getItem('chatTheme') || 'theme-dark';
                changeTheme(savedTheme);
            }

            // --- Start the App ---
            init();
        });
    </script>
</body>
</html>


