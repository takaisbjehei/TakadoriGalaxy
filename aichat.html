<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>TAKA AI</title>
  <link rel="manifest" href="manifest.json" />
  <link rel="icon" href="avatar.png" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    * {
      scroll-behavior: smooth;
      -webkit-font-smoothing: antialiased;
      text-rendering: optimizeLegibility;
    }
    .bubble-container {
      display: flex;
      gap: 8px;
      margin-bottom: 5px;
      align-items: flex-start;
    }
    .bubble {
      max-width: 90%;
      padding: 10px 15px;
      border-radius: 1rem;
      white-space: pre-wrap;
      word-wrap: break-word;
      will-change: transform, opacity;
      backface-visibility: hidden;
    }
    .user-bubble {
      background-color: #2563eb;
      color: white;
      margin-left: auto;
      border-bottom-right-radius: 0;
    }
    .bot-bubble {
      background-color: #f3f4f6;
      color: black;
      border-bottom-left-radius: 0;
    }
    .typing {
      font-style: italic;
      color: #9ca3af;
    }
    @keyframes dots {
      0% { content: ''; }
      33% { content: '.'; }
      66% { content: '..'; }
      100% { content: '...'; }
    }
    #thinking::after {
      content: '.';
      animation: dots 1s steps(3, end) infinite;
    }
    .mode-select {
      background: rgba(255,255,255,0.1);
      backdrop-filter: blur(10px);
    }
    #chatbox {
      transform: translateZ(0);
      overflow-anchor: none;
    }
    .avatar {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      object-fit: cover;
      margin-top: 5px;
    }
    .sidebar {
      width: 260px;
      height: 100vh;
      position: fixed;
      left: 0;
      top: 0;
      background: white;
      border-right: 1px solid #e5e7eb;
      transition: transform 0.3s ease;
      z-index: 40;
      overflow-y: auto;
    }
    .dark .sidebar {
      background: #1e1e2d;
      border-right: 1px solid #2d3748;
    }
    .sidebar-header {
      padding: 1rem;
      border-bottom: 1px solid #e5e7eb;
    }
    .dark .sidebar-header {
      border-bottom: 1px solid #2d3748;
    }
    .chat-item {
      padding: 0.75rem 1rem;
      cursor: pointer;
      border-bottom: 1px solid #e5e7eb;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .dark .chat-item {
      border-bottom: 1px solid #2d3748;
    }
    .chat-item:hover {
      background: #f3f4f6;
    }
    .dark .chat-item:hover {
      background: #2d3748;
    }
    .chat-item.active {
      background: #e5e7eb;
    }
    .dark .chat-item.active {
      background: #4a5568;
    }
    .new-chat-btn {
      width: 100%;
      padding: 0.75rem 1rem;
      margin: 0.5rem 0;
      border: 1px dashed #d1d5db;
      border-radius: 0.375rem;
      cursor: pointer;
      text-align: center;
    }
    .dark .new-chat-btn {
      border-color: #4a5568;
    }
    .main-content {
      margin-left: 260px;
      transition: margin-left 0.3s ease;
    }
    .sidebar-toggle {
      position: fixed;
      left: 1rem;
      top: 1rem;
      z-index: 50;
      background: white;
      border-radius: 50%;
      padding: 0.5rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      cursor: pointer;
      display: none;
    }
    .dark .sidebar-toggle {
      background: #1e1e2d;
    }
    @media (max-width: 768px) {
      .sidebar {
        transform: translateX(-100%);
      }
      .sidebar.open {
        transform: translateX(0);
      }
      .main-content {
        margin-left: 0;
      }
      .sidebar-toggle {
        display: block;
      }
    }
  </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-white min-h-screen transition-colors duration-300">
  <!-- Sidebar Toggle Button -->
  <div class="sidebar-toggle" id="sidebarToggle">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
    </svg>
  </div>

  <!-- Sidebar -->
  <div class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <button class="new-chat-btn" id="newChatBtn">
        + New Chat
      </button>
    </div>
    <div id="chatHistory"></div>
  </div>

  <!-- Main Content -->
  <div class="main-content max-w-3xl mx-auto p-4 pt-20 flex flex-col h-[calc(100vh-80px)]" id="mainContent">
    <div class="flex justify-between items-center mb-2">
      <div class="flex items-center gap-3">
        <img src="avatar.png" class="w-10 h-10 rounded-full" loading="eager" alt="TAKA AI Avatar"/>
        <h1 class="text-2xl font-bold">TAKA AI</h1>
      </div>
      <select id="mode" class="mode-select rounded px-3 py-1 text-sm dark:bg-gray-800 dark:text-white"></select>
    </div>

    <div id="desc" class="text-sm italic mb-2 text-gray-700 dark:text-gray-300">Loading...</div>

    <div id="chatbox" class="flex-1 overflow-y-auto space-y-2 p-2 bg-white dark:bg-gray-800 rounded-lg shadow-inner"></div>

    <div class="mt-4 flex">
      <input id="userInput" type="text" placeholder="Ask something..."
        class="flex-1 px-4 py-2 rounded-l-lg border dark:bg-gray-700 dark:border-gray-600"
        autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <button id="sendButton" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-r-lg transition-colors">Send</button>
    </div>
  </div>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    const supabase = createClient(
      "https://vmronlbzksuiikspvlvz.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZtcm9ubGJ6a3N1aWlrc3B2bHZ6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk5ODMwNTcsImV4cCI6MjA2NTU1OTA1N30.WMKbpJn1aavkwQDmsYq_-4EMSLL9tc4LexpmRSCsmSM"
    );

    // DOM Elements
    const modeSelect = document.getElementById("mode");
    const modeDescBox = document.getElementById("desc");
    const chatbox = document.getElementById("chatbox");
    const userInput = document.getElementById("userInput");
    const sendButton = document.getElementById("sendButton");
    const sidebar = document.getElementById("sidebar");
    const sidebarToggle = document.getElementById("sidebarToggle");
    const chatHistory = document.getElementById("chatHistory");
    const newChatBtn = document.getElementById("newChatBtn");

    // API Configuration
    const API_CONFIGS = [
      {
        endpoint: "https://llm.chutes.ai/v1/chat/completions",
        apiKey: "cpk_ae2395a5321940e6b3b24b4d51921ef2.2fe6509bc2a35be39e98a9a6f4b42a5b.h1vSu7eUd5g48HELY2GVXy9uObrOVGKK",
        model: "deepseek-ai/DeepSeek-V3-0324"
      },
      {
        endpoint: "https://llm.chutes.ai/v1/chat/completions",
        apiKey: "cpk_99378916287c495c9d1279af9b0a9063.2fe6509bc2a35be39e98a9a6f4b42a5b.UtrOZrL0d05xpb04QQuq4L0ouNbsLUF5",
        model: "deepseek-ai/DeepSeek-V3-0324"
      },
      {
        endpoint: "https://llm.chutes.ai/v1/chat/completions",
        apiKey: "cpk_25632a3253e04ffab45b2791f3316314.2fe6509bc2a35be39e98a9a6f4b42a5b.OEMDDYtbPBDLce1V4RbRD9RkagX61XU0",
        model: "deepseek-ai/DeepSeek-V3-0324"
      },
      {
        endpoint: "https://llm.chutes.ai/v1/chat/completions",
        apiKey: "cpk_cc62c97679bc4fda82032c03e391d40e.2fe6509bc2a35be39e98a9a6f4b42a5b.nvdRGo0TB6HUAoIHkY3UZtkycbRBhgzc",
        model: "deepseek-ai/DeepSeek-V3-0324"
      },
      {
        endpoint: "https://llm.chutes.ai/v1/chat/completions",
        apiKey: "cpk_7f6b157824be48e6a310985d940f5cb8.2fe6509bc2a35be39e98a9a6f4b42a5b.HYHIUKd7PsPl6qNRgn0zkeWdwRarVgNu",
        model: "deepseek-ai/DeepSeek-V3-0324"
      }
    ];

    // State
    let history = [];
    let isProcessing = false;
    let currentChatId = null;
    let chats = [];
    let isMobile = window.innerWidth <= 768;

    // Initialize
    document.addEventListener('DOMContentLoaded', initApp);

    async function initApp() {
      setupEventListeners();
      await loadModes();
      loadChatHistory();
      userInput.focus();
      
      if (isMobile) {
        sidebar.classList.remove('open');
      }
    }

    function setupEventListeners() {
      // Sidebar toggle
      sidebarToggle.addEventListener('click', toggleSidebar);
      
      // New chat button
      newChatBtn.addEventListener('click', handleNewChat);

      // Send message
      sendButton.addEventListener('click', sendMessage);
      userInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });

      // Window resize handler
      window.addEventListener('resize', handleResize);
    }

    function toggleSidebar() {
      sidebar.classList.toggle('open');
    }

    function handleNewChat() {
      startNewChat();
      if (isMobile) {
        sidebar.classList.remove('open');
      }
    }

    function handleResize() {
      isMobile = window.innerWidth <= 768;
      if (!isMobile) {
        sidebar.classList.add('open');
      }
    }

    // Chat History Functions
    function loadChatHistory() {
      const savedChats = localStorage.getItem('takaAiChats');
      if (savedChats) {
        chats = JSON.parse(savedChats);
        renderChatHistory();
        
        if (chats.length > 0) {
          loadChat(chats[0].id);
        } else {
          startNewChat();
        }
      } else {
        startNewChat();
      }
    }

    function renderChatHistory() {
      chatHistory.innerHTML = '';
      
      chats.forEach(chat => {
        const chatItem = document.createElement('div');
        chatItem.className = 'chat-item';
        chatItem.textContent = chat.title || `Chat ${formatDate(chat.createdAt)}`;
        chatItem.dataset.chatId = chat.id;
        
        if (chat.id === currentChatId) {
          chatItem.classList.add('active');
        }
        
        chatItem.addEventListener('click', () => {
          loadChat(chat.id);
          if (isMobile) {
            sidebar.classList.remove('open');
          }
        });
        
        chatHistory.appendChild(chatItem);
      });
    }

    function startNewChat() {
      const newChatId = Date.now().toString();
      currentChatId = newChatId;
      
      const newChat = {
        id: newChatId,
        title: 'New Chat',
        createdAt: new Date().toISOString(),
        messages: []
      };
      
      chats.unshift(newChat);
      saveChats();
      renderChatHistory();
      
      chatbox.innerHTML = '';
      history = [];
      
      // Show welcome message for new chats
      const welcomeMessage = modeDescBox.textContent || "Hello! I'm TAKA AI. How can I help you today?";
      addBubble(welcomeMessage, "bot");
    }

    function loadChat(chatId) {
      const chat = chats.find(c => c.id === chatId);
      if (!chat) return;
      
      currentChatId = chatId;
      renderChatHistory();
      
      chatbox.innerHTML = '';
      history = [];
      
      // Show welcome message first
      const welcomeMessage = modeDescBox.textContent || "Hello! I'm TAKA AI. How can I help you today?";
      addBubble(welcomeMessage, "bot");
      
      // Load chat messages
      chat.messages.forEach(msg => {
        addBubble(msg.content, msg.role === 'user' ? 'user' : 'bot');
        history.push({
          role: msg.role,
          content: msg.content
        });
      });
      
      chatbox.scrollTop = chatbox.scrollHeight;
    }

    function saveChats() {
      localStorage.setItem('takaAiChats', JSON.stringify(chats));
    }

    function formatDate(dateString) {
      const date = new Date(dateString);
      return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    }

    // Mode Handling
    async function loadModes() {
      try {
        const { data } = await supabase.from("modes")
          .select("name, description, model")
          .eq("enabled", true)
          .order("id", { ascending: false })
          .limit(10);
        
        modeSelect.innerHTML = '';
        
        if (data?.length) {
          data.forEach(mode => {
            const option = new Option(mode.name, mode.name);
            option.dataset.desc = mode.description || '';
            option.dataset.model = mode.model || 'deepseek-ai/DeepSeek-V3-0324';
            modeSelect.add(option);
          });
          updateModeDesc();
        } else {
          modeSelect.add(new Option("Default", "Default"));
          modeDescBox.textContent = "Hello! I'm TAKA AI. How can I help you today?";
        }
      } catch (error) {
        console.error("Error loading modes:", error);
        modeSelect.add(new Option("Default", "Default"));
        modeDescBox.textContent = "Hello! I'm TAKA AI. How can I help you today?";
      }
    }

    function updateModeDesc() {
      const selected = modeSelect.selectedOptions[0];
      const desc = selected?.dataset?.desc || "Hello! I'm TAKA AI. How can I help you today?";
      modeDescBox.textContent = desc;
      
      // Update welcome message if in a new chat
      if (!chats.find(c => c.id === currentChatId)?.messages?.length) {
        chatbox.innerHTML = '';
        addBubble(desc, "bot");
      }
    }

    modeSelect.addEventListener("change", updateModeDesc);

    // Chat Functions
    function addBubble(text, type) {
      const container = document.createElement("div");
      container.className = "bubble-container";
      
      if (type === "bot") {
        container.innerHTML = `
          <img src="avatar.png" class="avatar" alt="Bot Avatar">
          <div class="bubble bot-bubble"></div>
        `;
      } else {
        container.innerHTML = `
          <div style="width: 30px"></div>
          <div class="bubble user-bubble"></div>
        `;
      }

      const bubble = container.querySelector('.bubble');
      chatbox.appendChild(container);

      if (type === "bot") {
        let i = 0;
        const animate = () => {
          if (i < text.length) {
            bubble.textContent = text.substring(0, i + 1);
            i++;
            requestAnimationFrame(animate);
          }
          chatbox.scrollTop = chatbox.scrollHeight;
        };
        animate();
      } else {
        bubble.textContent = text;
        chatbox.scrollTop = chatbox.scrollHeight;
      }
    }

    async function sendMessage() {
      const message = userInput.value.trim();
      if (!message || isProcessing) return;

      // Clear input immediately
      userInput.value = "";
      isProcessing = true;

      // Add user message to UI
      addBubble(message, "user");

      // Initialize chat if needed
      if (!currentChatId) {
        startNewChat();
      }

      const currentChat = chats.find(c => c.id === currentChatId);
      
      // Set chat title from first message
      if (currentChat.messages.length === 0) {
        currentChat.title = message.length > 30 ? 
          message.substring(0, 30) + '...' : message;
        saveChats();
        renderChatHistory();
      }

      // Add to history
      currentChat.messages.push({
        role: 'user',
        content: message,
        timestamp: new Date().toISOString()
      });
      saveChats();

      // Show thinking indicator
      const thinking = document.createElement("div");
      thinking.className = "typing";
      thinking.id = "thinking";
      thinking.textContent = "TAKA AI is thinking";
      chatbox.appendChild(thinking);
      chatbox.scrollTop = chatbox.scrollHeight;

      try {
        const selectedOption = modeSelect.selectedOptions[0];
        const systemMessage = `You are TAKA AI. ${modeDescBox.textContent || "You are a helpful assistant."}`;
        
        // Try all APIs in sequence
        let response = null;
        for (const apiConfig of API_CONFIGS) {
          try {
            response = await fetchAPI({
              endpoint: apiConfig.endpoint,
              apiKey: apiConfig.apiKey,
              model: apiConfig.model,
              systemMessage,
              message,
              history
            });
            
            if (response) break; // Stop if we got a successful response
          } catch (err) {
            console.error(`API ${apiConfig.endpoint} failed:`, err);
            continue; // Try next API
          }
        }

        if (!response) {
          throw new Error("All APIs failed");
        }

        const reply = response.choices?.[0]?.message?.content || "I couldn't generate a response. Please try again.";
        
        // Update history
        history.push({ role: "user", content: message });
        history.push({ role: "assistant", content: reply });
        
        // Add to chat log
        currentChat.messages.push({
          role: 'assistant',
          content: reply,
          timestamp: new Date().toISOString()
        });
        saveChats();
        
        // Show response
        document.getElementById("thinking")?.remove();
        addBubble(reply, "bot");
        
      } catch (err) {
        console.error("All API attempts failed:", err);
        document.getElementById("thinking")?.remove();
        addBubble(
          "⚠️ All AI services are currently unavailable. Please try again later.", 
          "bot"
        );
      } finally {
        isProcessing = false;
      }
    }

    async function fetchAPI({endpoint, apiKey, model, systemMessage, message, history}) {
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 10000);

      const res = await fetch(endpoint, {
        method: "POST",
        headers: {
          "Authorization": `Bearer ${apiKey}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          model,
          messages: [
            { role: "system", content: systemMessage },
            ...history.slice(-6),
            { role: "user", content: message }
          ],
          temperature: 0.7
        }),
        signal: controller.signal
      });

      clearTimeout(timeoutId);
      
      if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
      return await res.json();
    }

    window.sendMessage = sendMessage;
  </script>
</body>
</html>
