<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>GroqGPT</title>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    /* 1. RESET & VARIABLES */
    :root {
      --bg-sidebar: #202123;
      --bg-main: #343541;
      --bg-card: #444654;
      --text-primary: #ECECF1;
      --input-bg: #40414f;
      --user-msg-bg: #343541;
      --ai-msg-bg: #444654;
    }
    body {
      margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: var(--bg-main); color: var(--text-primary);
      display: flex; height: 100vh; overflow: hidden;
    }

    /* 2. SIDEBAR (History) */
    #sidebar {
      width: 260px; background: var(--bg-sidebar);
      display: flex; flex-direction: column; padding: 10px;
      border-right: 1px solid #4d4d4f; flex-shrink: 0;
    }
    .new-chat {
      border: 1px solid #565869; padding: 10px; border-radius: 5px;
      text-align: left; background: transparent; color: white; cursor: pointer;
      display: flex; gap: 10px; align-items: center; transition: 0.2s;
    }
    .new-chat:hover { background: #2A2B32; }
    #history { flex: 1; overflow-y: auto; margin-top: 20px; }
    .hist-item {
      padding: 10px; border-radius: 5px; cursor: pointer;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 14px;
      color: #ececf1; margin-bottom: 2px;
    }
    .hist-item:hover { background: #2A2B32; }

    /* 3. MAIN CHAT AREA */
    #main { flex: 1; display: flex; flex-direction: column; position: relative; }
    #chat-box { flex: 1; overflow-y: auto; scroll-behavior: smooth; padding-bottom: 120px; }

    /* Messages */
    .message { padding: 20px; display: flex; justify-content: center; line-height: 1.6; }
    .message.ai { background: var(--ai-msg-bg); border-bottom: 1px solid rgba(0,0,0,0.1); }
    .message.user { background: var(--user-msg-bg); }
    
    .msg-inner { width: 800px; max-width: 90%; display: flex; gap: 20px; }
    .avatar { 
      width: 30px; height: 30px; border-radius: 4px; flex-shrink: 0;
      display: flex; align-items: center; justify-content: center; font-weight: bold;
    }
    .user .avatar { background: #5436DA; }
    .ai .avatar { background: #19C37D; }
    
    .text { flex: 1; min-width: 0; }
    .text pre { background: black; padding: 15px; border-radius: 6px; overflow-x: auto; margin: 10px 0; }
    .text code { font-family: monospace; }

    /* 4. INPUT AREA */
    #input-area {
      position: absolute; bottom: 0; left: 0; right: 0;
      background: linear-gradient(180deg, rgba(53,55,64,0), var(--bg-main) 40%);
      padding: 30px; display: flex; justify-content: center;
    }
    .input-wrap { position: relative; width: 800px; max-width: 90%; }
    textarea {
      width: 100%; background: var(--input-bg); color: white;
      border: 1px solid rgba(0,0,0,0.2); border-radius: 12px;
      padding: 15px 45px 15px 15px; resize: none; outline: none;
      font-family: inherit; box-shadow: 0 0 10px rgba(0,0,0,0.2);
      height: 54px; max-height: 200px;
    }
    button#send {
      position: absolute; right: 10px; bottom: 12px;
      background: transparent; border: none; cursor: pointer; color: #ccc;
    }
    button#send:hover { color: white; }

    /* Mobile */
    @media(max-width: 768px) {
      #sidebar { display: none; } /* Hide sidebar on mobile */
    }
  </style>
</head>
<body>

<div id="sidebar">
  <button class="new-chat" onclick="newChat()">+ New Chat</button>
  <div id="history"></div>
  <div style="margin-top:auto; font-size:12px; color:#666; padding:10px;">LocalStorage Active</div>
</div>

<div id="main">
  <div id="chat-box"></div>
  <div id="input-area">
    <div class="input-wrap">
      <textarea id="inp" placeholder="Send a message..." rows="1"></textarea>
      <button id="send">âž¤</button>
    </div>
  </div>
</div>

<script>
// --- CONFIGURATION ---
// IMPORTANT: Ensure your backend handles {messages: [...]} format!
const API_URL = '/api/groq'; 

// --- STATE ---
let chats = JSON.parse(localStorage.getItem('my_chats') || '[]');
let activeId = null;

// --- DOM ELEMENTS ---
const chatBox = document.getElementById('chat-box');
const inp = document.getElementById('inp');
const histDiv = document.getElementById('history');

// --- INIT ---
init();

function init() {
  renderSidebar();
  if (chats.length > 0) loadChat(chats[0].id);
  else newChat();
}

// --- CORE FUNCTIONS ---
function newChat() {
  activeId = Date.now().toString();
  const chat = { id: activeId, title: 'New Conversation', msgs: [] };
  chats.unshift(chat);
  save();
  renderSidebar();
  renderChat();
}

function loadChat(id) {
  activeId = id;
  renderSidebar();
  renderChat();
}

async function send() {
  const text = inp.value.trim();
  if (!text) return;
  
  inp.value = '';
  
  // 1. Add User Msg
  addMsg('user', text);
  
  // 2. Add Placeholder AI Msg
  const aiMsgIndex = addMsg('assistant', 'Thinking...');
  
  // 3. Prepare History for API (System + Last 6 messages)
  const currentChat = chats.find(c => c.id === activeId);
  const context = [
    { role: "system", content: "You are a helpful AI." },
    ...currentChat.msgs.slice(0, -1).slice(-6).map(m => ({role: m.role, content: m.content}))
  ];

  try {
    const res = await fetch(API_URL, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ 
        model: 'llama3-8b-8192', // Change model here if needed
        messages: context,
        stream: true 
      })
    });

    if(!res.ok) throw new Error("API Error");

    // STREAMING HANDLER
    const reader = res.body.getReader();
    const decoder = new TextDecoder();
    let fullText = '';
    
    // Clear "Thinking..."
    currentChat.msgs[aiMsgIndex].content = ''; 

    while(true) {
      const { done, value } = await reader.read();
      if (done) break;
      const chunk = decoder.decode(value, {stream: true});
      fullText += chunk;
      
      // Update LIVE
      currentChat.msgs[aiMsgIndex].content = fullText;
      updateLastBubble(fullText);
    }

    // Auto-Title on first turn
    if(currentChat.msgs.length === 2) {
      currentChat.title = text.slice(0, 25);
      renderSidebar();
    }
    save();

  } catch (e) {
    currentChat.msgs[aiMsgIndex].content = "Error: " + e.message;
    renderChat();
  }
}

// --- HELPERS ---
function addMsg(role, content) {
  const chat = chats.find(c => c.id === activeId);
  chat.msgs.push({ role, content });
  renderChat();
  return chat.msgs.length - 1;
}

function save() {
  localStorage.setItem('my_chats', JSON.stringify(chats));
}

// --- RENDER ---
function renderSidebar() {
  histDiv.innerHTML = '';
  chats.forEach(c => {
    const div = document.createElement('div');
    div.className = 'hist-item';
    div.style.background = c.id === activeId ? '#343541' : '';
    div.innerText = c.title;
    div.onclick = () => loadChat(c.id);
    histDiv.appendChild(div);
  });
}

function renderChat() {
  chatBox.innerHTML = '';
  const chat = chats.find(c => c.id === activeId);
  if(!chat) return;

  chat.msgs.forEach(m => {
    const div = document.createElement('div');
    div.className = `message ${m.role === 'user' ? 'user' : 'ai'}`;
    // Parse Markdown
    const html = m.role === 'assistant' ? marked.parse(m.content) : m.content;
    div.innerHTML = `
      <div class="msg-inner">
        <div class="avatar">${m.role==='user'?'U':'AI'}</div>
        <div class="text">${html}</div>
      </div>
    `;
    chatBox.appendChild(div);
  });
  chatBox.scrollTop = chatBox.scrollHeight;
}

function updateLastBubble(text) {
  const bubbles = document.querySelectorAll('.message.ai .text');
  if(bubbles.length) {
    bubbles[bubbles.length-1].innerHTML = marked.parse(text);
    chatBox.scrollTop = chatBox.scrollHeight;
  }
}

// --- EVENTS ---
document.getElementById('send').addEventListener('click', send);
inp.addEventListener('keypress', (e) => {
  if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); send(); }
});
</script>
</body>
</html>
